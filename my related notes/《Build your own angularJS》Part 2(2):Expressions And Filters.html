<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.0.16 (451861)"/><meta name="altitude" content="14.95946216583252"/><meta name="author" content="markselby"/><meta name="created" content="2015-11-30 08:59:24 +0000"/><meta name="latitude" content="31.19380853415149"/><meta name="longitude" content="121.5955152009827"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2015-12-13 04:01:55 +0000"/><title>《Build your own angularJS》Part 2(2):Expressions And Filters</title></head><body>
<div>关于==和===的区别：<a href="http://stackoverflow.com/questions/359494/does-it-matter-which-equals-operator-vs-i-use-in-javascript-comparisons">http://stackoverflow.com/questions/359494/does-it-matter-which-equals-operator-vs-i-use-in-javascript-comparisons</a></div>
<div style="padding: 0px; border: 0px; font-size: 15px; clear: both; font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">
<div><span style="color: rgb(34, 34, 34);">The identity (<code style="padding: 1px 5px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; white-space: pre-wrap; background-color: rgb(238, 238, 238);">===</code>) operator behaves identically to the equality (<code style="padding: 1px 5px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; white-space: pre-wrap; background-color: rgb(238, 238, 238);">==</code>) operator except no type conversion is done, and the types must be the same to be considered equal.</span></div>
</div>
<div style="padding: 0px; border: 0px; font-size: 15px; clear: both; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">
<div><span style="font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif;"><span style="color: rgb(34, 34, 34);">Reference: </span><a href="http://www.c-point.com/javascript_tutorial/jsgrpComparison.htm" style=" padding: 0px; border: 0px; font-size: 15px; text-decoration: none; cursor: pointer; color: rgb(12, 101, 165);">Javascript Tutorial: Comparison Operators</a></span></div>
</div>
<div style="padding: 0px; border: 0px; font-size: 15px; clear: both; font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255);">
<div><span style="color: rgb(34, 34, 34);">The <code style=" padding: 1px 5px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; white-space: pre-wrap; background-color: rgb(238, 238, 238);">==</code> operator will compare for equality <em style=" padding: 0px; border: 0px; font-size: 15px; font-style: italic;">after doing any necessary type conversions</em>. The <code style=" padding: 1px 5px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; white-space: pre-wrap; background-color: rgb(238, 238, 238);">===</code>operator will <strong style=" padding: 0px; border: 0px; font-size: 15px; font-weight: bold;">not</strong> do the conversion, so if two values are not the same type <code style=" padding: 1px 5px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; white-space: pre-wrap; background-color: rgb(238, 238, 238);">===</code> will simply return <code style=" padding: 1px 5px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; white-space: pre-wrap; background-color: rgb(238, 238, 238);">false</code>. It's this case where <code style=" padding: 1px 5px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; white-space: pre-wrap; background-color: rgb(238, 238, 238);">===</code> will be faster, and may return a different result than <code style=" padding: 1px 5px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; white-space: pre-wrap; background-color: rgb(238, 238, 238);">==</code>. In all other cases performance will be the same.</span></div>
</div>
<div><br/></div>
<div>容易错的地方：</div>
<div>
<div style="padding: 5px; border: 0px; font-size: 13px; overflow: auto; max-height: 600px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; color: rgb(57, 51, 24); font-style: normal; font-variant: normal; font-weight: normal; letter-spacing: normal; orphans: auto; text-align: left; text-indent: 0px; text-transform: none; widows: 1; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(238, 238, 238);"><code style="padding: 0px; border: 0px; font-size: 13px; font-family: Consolas, Menlo, Monaco, 'Lucida Console', 'Liberation Mono', 'DejaVu Sans Mono', 'Bitstream Vera Sans Mono', 'Courier New', monospace, sans-serif; background-color: rgb(238, 238, 238);"><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 139);">var</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> a </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">=</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">[</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 0, 0);">1</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">,</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 0, 0);">2</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">,</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 0, 0);">3</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">];</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"><br/></span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 139);">var</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> b </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">=</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">[</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 0, 0);">1</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">,</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 0, 0);">2</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">,</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 0, 0);">3</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">];</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"><br/>
<br/></span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 139);">var</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> c </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">=</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">{</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> x</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">:</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 0, 0);">1</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">,</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> y</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">:</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 0, 0);">2</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">};</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"><br/></span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 139);">var</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> d </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">=</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">{</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> x</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">:</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 0, 0);">1</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">,</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> y</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">:</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 0, 0);">2</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">};</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"><br/>
<br/></span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 139);">var</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> e </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">=</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 0, 0);">"text"</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">;</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"><br/></span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 139);">var</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> f </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">=</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 0, 0);">"te"</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">+</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 0, 0);">"xt"</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">;</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"><br/>
<br/>
a </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">==</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> b           </span> <span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 128, 128);">// false</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"><br/>
a </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">===</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> b           </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 128, 128);">// false</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"><br/>
<br/>
c </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">==</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> d           </span> <span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 128, 128);">// false</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"><br/>
c </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">===</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> d           </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 128, 128);">// false</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"><br/>
<br/>
e </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">==</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> f           </span> <span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 128, 128);">// true</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"><br/>
e </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);">===</span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(0, 0, 0);"> f           </span><span style="padding: 0px; border: 0px; font-size: 13px; color: rgb(128, 128, 128);">// true</span></code></div>
</div>
<div>new String(“abc”)得到的<u>是一个对象</u>，String {0: "a", 1: "b", 2: "c", length: 3, [[PrimitiveValue]]: "abc"}</div>
<div><br/></div>
<div><br/></div>
<div>第七章：Operator Expressions</div>
<div>Unary Operators，包括+，-，!。</div>
<div>先从+入手，和Javascript的区别是对于undefined变量，Angular是当作0处理而不是NaN。1，增加AST的node type，’UnaryExpression’。</div>
<div>
<div style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:12.0pt;"><span style="background-color:#e4e4ff;">AST</span>.<span style="color:#7a7a43;">prototype</span>.<span style="color:#7a7a43;">unary </span>= <span style="color:#000080;font-weight:bold;">function</span>(){<br/>
    <span style="color:#000080;font-weight:bold;">if </span>(<span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">expect</span>(<span style="color:#008000;font-weight:bold;">'+'</span>)){<br/>
        <span style="color:#000080;font-weight:bold;">return </span>{<br/>
            <span style="color:#660e7a;font-weight:bold;">type</span>: <span style="background-color:#e4e4ff;">AST</span>.<span style="color:#660e7a;font-weight:bold;">UnaryExpression</span>,<br/>
            <span style="color:#660e7a;font-weight:bold;">operator</span>: <span style="color:#008000;font-weight:bold;">'+'</span>,<br/>
            <span style="color:#660e7a;font-weight:bold;">argument</span>: <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">primary</span>()<br/>
        };<br/>
    }<span style="color:#000080;font-weight:bold;">else</span>{<br/>
        <span style="color:#000080;font-weight:bold;">return this</span>.<span style="color:#7a7a43;">primary</span>();<br/>
    }<br/>
};<br/></div>
</div>
<div>2，Lexer中增加对符号的读取处理，而不是识别为unexpected next character。</div>
<div>然后处理!，同理。但是!符号要考虑它可能会是一个text，而不是operator，所以需要区分处理，即Lexer的readString方法中，push的是</div>
<div>
<div style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:12.0pt;"><span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#660e7a;font-weight:bold;">tokens</span>.<span style="color:#7a7a43;">push</span>({<br/>
    <span style="color:#660e7a;font-weight:bold;">text</span>: <span style="color:#458383;">rawString</span>,<br/>
    <span style="color:#660e7a;font-weight:bold;">value</span>: <span style="color:#458383;">string<br/></span>});<br/></div>
</div>
<div>Unary operators就这些了。</div>
<div>Multiplicative Operators，包括了 *,/,%。对符号的读取处理和Unary operator一样，assignment的左右改成this.multiplicative()，然后在compiler里面增加binary的处理。</div>
<div><br/></div>
<div>在符号的解析中优先级比较重要，现在顺序是Primary&lt;Unary&lt;Multiplicative&lt;Assignment。</div>
<div>现在如果有多个Multiplicative如 36*2%5，是会忽略掉一个operator之后的内容的。所以multiplicative方法中的if改成 while 循环</div>
<div><br/></div>
<div>然后处理加减法操作，AST增加新的方法additive。</div>
<div>然后处理Relational and equality operators，处理&gt;,&lt;,&lt;=,&gt;=，以及==, !=，===，判断出true或者false。</div>
<div><br/></div>
<div>接着处理relational and equality，正确的优先级顺序：</div>
<div>1. 2=="2"&gt;2==="2"      2. 2 == false === "2"      3. false === "2"      4. false</div>
<div>1. 2 + 3 &lt; 6 - 2      2. 5 &lt; 4      3. false</div>
<div>Lexer读符号的时候不再是只考虑一位，需要考虑==, ===的情况，因此else处理的时每次读符号需要考虑1，2，3位三种情况</div>
<div><br/></div>
<div>然后处理AND, OR operator，An interesting detail about logical operators is that they are short-circuited. AND &amp;&amp; 符号左边如果是false，右边则不会被执行。对应的测试例子：</div>
<div>
<p><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">it</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">short-circuits AND</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">,</span> <span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">function</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">() {<br/></span><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">var</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">invoked;<br/></span><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">var</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">scope = {</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(56.000000%, 13.000000%, 0.000000%)">fn</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">:</span> <span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">function</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">() { invoked =</span> <span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">true</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">; }};</span></p>
</div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">  parse</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">false &amp;&amp; fn()</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">)(scope);</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">  expect</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(invoked).</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">toBeUndefined</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">();</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'">});</span></div>
<div>同样，OR || 符号左边如果是True，右边也不会执行。AND比OR的优先级高。</div>
<div>
<div style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:12.0pt;"><span style="color:#000080;font-weight:bold;">case </span><span style="font-style:italic;">AST</span>.<span style="color:#660e7a;font-weight:bold;">LogicalExpression</span>:<br/>
    <span style="color:#458383;">intoId </span>= <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">nextId</span>();<br/>
    <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#660e7a;font-weight:bold;">state</span>.<span style="color:#660e7a;font-weight:bold;">body</span>.<span style="color:#7a7a43;">push</span>(<span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">assign</span>(<span style="color:#458383;">intoId</span>, <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">recurse</span>(ast.<span style="color:#660e7a;font-weight:bold;">left</span>)));<br/>
    <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">if_</span>(ast.<span style="color:#660e7a;font-weight:bold;">operator </span>=== <span style="color:#008000;font-weight:bold;">'&amp;&amp;'</span>? <span style="color:#458383;">intoId</span>: <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">not</span>(<span style="color:#458383;">intoId</span>), <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">assign</span>(<span style="color:#458383;">intoId</span>, <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">recurse</span>(ast.<span style="color:#660e7a;font-weight:bold;">right</span>)));<br/>
    <span style="color:#000080;font-weight:bold;">return </span><span style="color:#458383;">intoId</span>;<br/></div>
</div>
<div><br/></div>
<div>最后处理Ternary Operator，..?..:..。Lexer先移除?符号，然后分别解释为赋值语句，test?consequent:alternate，用两个this.if_完成处理。</div>
<div>优先级顺序：</div>
<div><br/></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">1. Primary expressions: Lookups, function calls, method calls.<br/>
2. Unary expressions:</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">+a</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">,</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">-a</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">,</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">!a</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">.<br/>
3. Multiplicative arithmetic expressions:</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">a * b</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">,</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">a / b</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">, and</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">a % b</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">.<br/>
4. Additive arithmetic expressions:</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">a + b</span> <span style="font-size: 9.000000pt; font-family: 'LMRoman9'">and</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">a - b</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">.<br/>
5. Relationalexpressions:</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">a&lt;b</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">,</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">a&gt;b</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">,</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">a&lt;=b</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">,and</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">a&gt;=b</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">.<br/>
6. Equality testing expressions:</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">a == b</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">,</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">a != b</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">,</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">a === b</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">, and</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">a !== b</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">. 7. Logical AND expressions:</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">a &amp;&amp; b</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">.<br/>
8. Logical OR expressions:</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">a || b</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">.</span></div>
<div><span style="font-size: 9pt;"><span style="font-family: LMRoman9;">9. Ternary expressions:</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">a ? b : c</span><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">.</span></span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMRoman9'">10. Assignments:</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">a = b</span><span style="font-family: LMRoman9;"><span style="font-size: 9pt;">.</span></span></div>
<div><br/></div>
<div>对优先级还需要做一些调整，AST.prototype.primary的if else语句先expect (，这样会最先处理括号。然后还需要处理多个语句的情况，这个时候返回值是最后一个语句，如：</div>
<div><br/></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">it</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">returns the value of the last statement</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">,</span> <span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">function</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">() {</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">expect</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">parse</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">a = 1; b = 2; a + b</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">)({})).</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">toBe</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 63.000000%, 44.000000%)">3</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">);</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'">});</span></div>
<div><br/></div>
<div>总结：</div>
<ol>
<li>AngularJS的各个expression支持的operator的实现</li>
<li>优先级在AST中的实现</li>
<li>Angular的arithmetic expressions比Javascript更加forgiving</li>
<li>对多个statements的支持</li>
</ol>
<div><br/></div>
<div>第八章：Filters，只有AngularJS有的feature，Javascript不包含</div>
<div>filter和plain function的区别：filters不需要被绑定在scopes上才能调用。</div>
<div>filter service：实现register 和 filter函数，</div>
<div>register：绑定name和factory function，实现方法是绑定在一个storage object上。如果是多个name, factory，则判断_.isObject(name)，如果是则_.map(name, function(factory, name)….</div>
<div>暂时filter service先实现这些，之后有了dependency injection system再讨论</div>
<div><br/></div>
<div>Filter Expressions：解析如 parse(‘aString | upcase’)，先识别’|’符号，然后新建filter函数，</div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">AST</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">prototype</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">filter</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">=</span> <span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">function</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">() {</span> <span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">var</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">left =</span> <span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">this</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">assignment</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">();</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">if</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">this</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">expect</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">|</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">)) {</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'">left = {</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(56.000000%, 13.000000%, 0.000000%)">type</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">:</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">AST</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">CallExpression</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">,</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(56.000000%, 13.000000%, 0.000000%)">callee</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">:</span> <span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">this</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">identifier</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(),</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(56.000000%, 13.000000%, 0.000000%)">arguments</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">: [left],</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(56.000000%, 13.000000%, 0.000000%)">filter</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">:</span> <span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">true</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'">}; }</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">return</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">left; };</span></div>
<div><br/></div>
<div>然后在compiler中，如果有AST.CallExpression节点的filter=true，则返回callee(args)的形式。</div>
<div>
<div style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:12.0pt;"><span style="background-color:#e4e4ff;">ASTCompiler</span>.<span style="color:#7a7a43;">prototype</span>.<span style="color:#7a7a43;">filter </span>= <span style="color:#000080;font-weight:bold;">function</span>(name){<br/>
    <span style="color:#000080;font-weight:bold;">var </span><span style="color:#458383;">filterId </span>= <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">nextId</span>(<span style="color:#000080;font-weight:bold;">true</span>);<br/>
    <span style="color:#000080;font-weight:bold;">if </span>(!<span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#660e7a;font-weight:bold;">state</span>.<span style="color:#660e7a;font-weight:bold;">filters</span>.<span style="color:#7a7a43;">hasOwnProperty</span>(<span style="color:#008000;font-weight:bold;">'name'</span>)){<br/>
        <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#660e7a;font-weight:bold;">state</span>.<span style="color:#660e7a;font-weight:bold;">filters</span>[name] = <span style="color:#458383;">filterId</span>;<br/>
        <span style="color:#000080;font-weight:bold;">return </span><span style="color:#458383;">filterId</span>;<br/>
    }<br/>
    <span style="color:#000080;font-weight:bold;">return this</span>.<span style="color:#660e7a;font-weight:bold;">state</span>.<span style="color:#660e7a;font-weight:bold;">filters</span>[name];<br/>
};<br/>
<br/>
<span style="background-color:#e4e4ff;">ASTCompiler</span>.<span style="color:#7a7a43;">prototype</span>.<span style="color:#7a7a43;">filterPrefix </span>= <span style="color:#000080;font-weight:bold;">function</span>(){<br/>
    <span style="color:#000080;font-weight:bold;">if </span>(<span style="color:#660e7a;font-weight:bold;font-style:italic;">_</span>.<span style="color:#660e7a;font-weight:bold;">isEmpty</span>(<span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#660e7a;font-weight:bold;">state</span>.<span style="color:#660e7a;font-weight:bold;">filters</span>)){<br/>
        <span style="color:#000080;font-weight:bold;">return </span><span style="color:#008000;font-weight:bold;">''</span>;<br/>
    }<span style="color:#000080;font-weight:bold;">else</span>{<br/>
        <span style="color:#000080;font-weight:bold;">var </span><span style="color:#458383;">prefix_parts </span>= <span style="color:#660e7a;font-weight:bold;font-style:italic;">_</span>.<span style="color:#660e7a;font-weight:bold;">map</span>(<span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#660e7a;font-weight:bold;">state</span>.<span style="color:#660e7a;font-weight:bold;">filters</span>, <span style="color:#000080;font-weight:bold;">function</span>(varName, filterName){<br/>
            <span style="color:#000080;font-weight:bold;">return </span>varName+<span style="color:#008000;font-weight:bold;">'=filter('</span>+<span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">escape</span>(filterName)+<span style="color:#008000;font-weight:bold;">')'</span>;<br/>
        }, <span style="color:#000080;font-weight:bold;">this</span>);<br/>
        <span style="color:#000080;font-weight:bold;">return </span><span style="color:#008000;font-weight:bold;">'var '</span>+<span style="color:#458383;">prefix_parts</span>.<span style="color:#7a7a43;">join</span>(<span style="color:#008000;font-weight:bold;">','</span>)+<span style="color:#008000;font-weight:bold;">';'</span>;<br/>
    }<br/>
};<br/></div>
</div>
<div><br/></div>
<div>filter函数将callee的信息存在this.state.filters内，当AST被recurse之后，state.filters会包含所有expression中用到的filter。filter函数也需要在runtime被用到，和之前的ensureSafe...一样处理。</div>
<div><br/></div>
<div>Filter chain expressions：AST.prototype.filter中的if (this.expect(‘|’)) 改成 while 就可以了</div>
<div>filters additional arguments：filter可以有多个参数，如：</div>
<div style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:12.0pt;">it(<span style="color:#008000;font-weight:bold;">'can pass an additional argument to filters'</span>, <span style="color:#000080;font-weight:bold;">function</span>() {<br/>
    <span style="color:#660e7a;font-weight:bold;font-style:italic;">register</span>(<span style="color:#008000;font-weight:bold;">'repeat'</span>, <span style="color:#000080;font-weight:bold;">function</span>() {<br/>
        <span style="color:#000080;font-weight:bold;">return function</span>(s, times) {<br/>
            <span style="color:#000080;font-weight:bold;">return </span><span style="color:#660e7a;font-weight:bold;font-style:italic;">_</span>.<span style="color:#660e7a;font-weight:bold;">repeat</span>(s, times);<br/>
        };<br/>
    });<br/>
    <span style="color:#000080;font-weight:bold;">var </span><span style="color:#458383;">fn </span>= <span style="color:#660e7a;font-weight:bold;font-style:italic;">parse</span>(<span style="color:#008000;font-weight:bold;">'"hello" | repeat:3'</span>);<br/>
    expect(<span style="color:#458383;">fn</span>()).<span style="font-style:italic;">toEqual</span>(<span style="color:#008000;font-weight:bold;">'hellohellohello'</span>);</div>
<div><span style="font-size: 12pt;"><span style="font-family: Menlo;">});</span></span></div>
<div>在AST.prototype中增加对多个args的处理，while (this.expect(‘:’))…，args中push this.assignment()</div>
<div><br/></div>
<div>The Filter Filter：</div>
<div>新建filter_filter.js，在filter.js中注册filter filter，filterFilter返回一个函数，参数是array，filterExpr</div>
<div>如果filterExpr是函数则直接使用lodash的filter函数，如果是字符串则创建一个predicate function</div>
<div>filter对象还可以是object，那么就需要deepCompare，比较object内部的value。</div>
<div><b><span style="font-size: 12pt;"><span style="font-family: Menlo;"><span style="color: rgb(0, 0, 128);"><br/></span></span></span></b></div>
<div><span style="font-size: 12pt;"><span style="font-family: Menlo;"><span style="color:#000080;font-weight:bold;">function </span><span style="font-style:italic;">deepCompare</span>(actual, expected, comparator){ <span style="color:#808080;font-style:italic;">// deep compare, concerning object</span></span></span></div>
<div style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:12.0pt;"><span style="color:#808080;font-style:italic;">   </span> <span style="color:#000080;font-weight:bold;">if </span>(<span style="color:#660e7a;font-weight:bold;font-style:italic;">_</span>.<span style="color:#660e7a;font-weight:bold;">isObject</span>(actual)) {<br/>
        <span style="color:#000080;background-color:#e4e4ff;font-weight:bold;">return </span><span style="background-color:#e4e4ff;">_.some(actual, </span><span style="color:#000080;background-color:#e4e4ff;font-weight:bold;">function</span><span style="background-color:#e4e4ff;">(value){ </span> <span style="color:#808080;background-color:#e4e4ff;font-style:italic;">//Checks if predicate returns truthy for any element of collection<br/></span><span style="color:#808080;background-color:#e4e4ff;font-style:italic;">           </span> <span style="color:#000080;background-color:#e4e4ff;font-weight:bold;">return </span><span style="background-color:#e4e4ff;">deepCompare(value, expected, comparator);<br/></span><span style="background-color:#e4e4ff;">        });</span><br/>
    }<span style="color:#000080;font-weight:bold;">else</span>{<br/>
        <span style="color:#000080;background-color:#e4e4ff;font-weight:bold;">return </span><span style="background-color:#e4e4ff;">comparator(actual, expected);</span><br/>
    }<br/>
}<br/></div>
<div><br/></div>
<div>对object用了_.some，只要有正例就返回True</div>
<div>Filer expression也可能是数字或者布尔值，用_.isNumber或者_.isBoolean判断，分别建立对应的createPredicateFn。对Null和Undefined在comparator中分别处理，如果actual 和 expect都是Null则返回actual === expected</div>
<div>Negated Filtering：filter string 前面加一个!，作为反选。在deepCompare中判断_.startsWith(expected, 1)，如果是!开头则返回!deepCompare(…)。</div>
<div><br/></div>
<div>Filtering with object criteria: filter条件可以是一个对象，如</div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">var</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">fn =</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">parse</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">arr | filter:{name: "o"}</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">);</span></div>
<div>并且对象可以是nested object，也可以反选，如</div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">var</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">fn =</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">parse</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">arr | filter:{name: {first: "!o"}}</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">);</span></div>
<div>方法是loop over the expected criteria object, and for each value deep-compare the corresponding value in the actual object. 使用了_.every寻找满足所有条件的match，并且使用_.toPlainObject(object)处理对象，防止对prototype inheritance的所有inherited properties都进行检查。</div>
<div><br/></div>
<div>Filtering With Object Wildcards：$代指任意属性，如</div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">var</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">fn =</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">parse</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">arr | filter:{$: "o"}</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">);</span></div>
<div>$可以表示出在nested object的哪一级，本身的filter object也可以是nested。实现方法是递归调用deepCompare的时候，给方法增加两个flag参数，表示是否matchAnyProperty，是否inWildCard。</div>
<div><br/></div>
<div>Custom comparators：提供自定义的comparator function。createPredicateFn的时候判断comparator是否已有，并且_.isFunction，不是的话再定义comparator函数</div>
<div>comparator要求严格相等条件：增加一个布尔值表示是否严格相等，</div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">var</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">fn =</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">parse</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">arr | filter:{name: "Jo"}:true</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">);</span></div>
<div>如果comparator为true，直接使用_.isEqual即可。</div>
<div><br/></div>
<div>总结：</div>
<ol>
<li>filters的实质上是一个function call，用pipe operator |。Angular不支持bitwise operators</li>
<li>filters的注册和获得是通过filter service，绑定在一个stored object上</li>
<li>filter expressions被AST builder和compiler处理为call expressions，优先级最低</li>
<li>AST compiler来产生在runtime查找一个expression中所有用到的filters的代码</li>
<li>filter invocations可以是chained，也可以传递其他的参数</li>
<li>内置的一些filter是如何工作的</li>
<li>wildcard $ keys，custom comparators</li>
</ol>
<div><br/></div>
<div><br/></div>
<div><br/></div>
<div><br/></div>
<div><br/></div>
<div><br/></div>
<div><br/></div>
<div><br/></div>
</body></html>