<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.0.16 (451861)"/><meta name="altitude" content="13.23477077484131"/><meta name="author" content="markselby"/><meta name="created" content="2015-11-18 02:19:48 +0000"/><meta name="latitude" content="31.19379466342568"/><meta name="longitude" content="121.5955279874387"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2015-11-30 08:59:21 +0000"/><title>《Build your own angularJS》Part 2(1):Expressions And Filters</title></head><body>
<div title="Page 190">Javascript是值传递还是引用传递？</div>
<div title="Page 190"><a href="http://stackoverflow.com/questions/518000/is-javascript-a-pass-by-reference-or-pass-by-value-language?lq=1">http://stackoverflow.com/questions/518000/is-javascript-a-pass-by-reference-or-pass-by-value-language?lq=1</a></div>
<div title="Page 190">the situation is that the item passed in is passed by value. But the item that is passed by value is itself a reference. Technically, this is called <u>call-by-sharing</u>.</div>
<div title="Page 190">在函数内，如果改参数变量本身没有效果，但是如果改参数的INTERNAL property，会改变参数内部的值。</div>
<div title="Page 190">In practical terms, this means that if you change the parameter itself (as with num and obj2), that won't affect the item that was fed into the parameter. But if you change the INTERNALS of the parameter, that will propagate back up (as with obj1).</div>
<div title="Page 190"><br/></div>
<div title="Page 190"><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%202(1)%3AExpressions%20And%20Filters.resources/83451D35-4596-4367-A913-B7DED596FE93.png" height="727" width="560"/></div>
<div title="Page 190">expression: {{ }}</div>
<div title="Page 190"><br/></div>
<div title="Page 190">Chapter 5: Literal expressions</div>
<div title="Page 190"><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%202(1)%3AExpressions%20And%20Filters.resources/80B21527-292F-4D0A-9A94-F56747F7A1CA.png" height="1015" width="496"/></div>
<div title="Page 190">Lexer: expression string =&gt; tokens parsed from the string, 如 a+b 变为”a, +, b"</div>
<div title="Page 190">AST Builder: tokens =&gt; Abstract Syntax Tree, 例如：</div>
<div title="Page 190"><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%202(1)%3AExpressions%20And%20Filters.resources/8D59A396-10F4-41F6-B4B8-AF4E76214217.png" height="272" width="299"/></div>
<div title="Page 190">AST Compiler: AST syntax tree =&gt; Javascript function，最终得到一个Javascript函数</div>
<div title="Page 190">Parser负责合并上面描述的这些操作的底层步骤</div>
<div title="Page 190"><br/></div>
<div title="Page 190">Lexer, AST Builder, AST Compiler, Parse： constructor function，prototype添加function</div>
<div title="Page 190">1，解析一个字符串为一个数：”42”为42</div>
<div title="Page 190">tokenizer需要text 和 numeric value, 得到tokens：</div>
<div title="Page 190">{</div>
<div title="Page 190">     text:  ’42',</div>
<div title="Page 190">     value: 42</div>
<div title="Page 190">}</div>
<div title="Page 190">AST Builder将tokens解析为一个AST：</div>
<div title="Page 190">{</div>
<div title="Page 190">     type: AST.Program,</div>
<div title="Page 190">     body: {</div>
<div title="Page 190">          type: AST.Literal,</div>
<div title="Page 190">          value: 42</div>
<div title="Page 190">     }</div>
<div title="Page 190">}</div>
<div title="Page 190">AST Compiler将tree转换成一个function，用一个递归的recurse方法来遍历整个树。this.state = {body:[]}，将遍历到的value转化成return语句压到数组里</div>
<div title="Page 190">最后返回一个return new Function(this.state.body.join(‘’));</div>
<div title="Page 190">最后变成了 function(){return 42;} 完成解析</div>
<div title="Page 190">2，解析小数点，例如4.2，.42（0被省略）</div>
<div title="Page 190">修改readNumber方法，让小数点也能够被认识为value即可，javascript自带支持小数点（似乎没考虑两个点的情况）</div>
<div title="Page 190">3，解析科学计数法，如42e3，或者.42e3，4200e-2, .42e+2， .42E2等，</div>
<div title="Page 190">这个时候修改readNumber方法，能够解析+,-,e这几个符号也就可以过测试了，但是太草率，因为同时对于invalid notation需要抛出错误，所以没那么简单。</div>
<div title="Page 190">步骤如下：1，引入exponent operator，e后面可以跟一个+,-或者数字；2，readNumber，考虑各种情况</div>
<div title="Page 190">4，解析字符串，如”’abc’"</div>
<div title="Page 190">解析成function的时候会变成function(){ return abc; }, 需要使用escape方法，给abc加引号。</div>
<div title="Page 190">考虑首尾的引号需要对应，否则抛出 unmatched quote</div>
<div title="Page 190">对于escape character的解析：包括\n, \f, \r, \t, \v, \’, \”, 以及unicode如\u00A0</div>
<div style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:12.0pt;"><span style="font-style:italic;">ASTCompiler</span>.<span style="color:#7a7a43;">prototype</span>.<span style="color:#7a7a43;">escape </span>= <span style="color:#000080;font-weight:bold;">function</span>(value){<br/>
    <span style="color:#000080;font-weight:bold;">if </span>(<span style="color:#660e7a;font-weight:bold;font-style:italic;">_</span>.<span style="color:#660e7a;font-weight:bold;">isString</span>(value)){<br/>
        <span style="color:#000080;font-weight:bold;">return </span><span style="color:#008000;font-weight:bold;">'</span><span style="color:#000080;font-weight:bold;">\'</span><span style="color:#008000;font-weight:bold;">' </span>+ value.<span style="color:#7a7a43;">replace</span>(<span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#660e7a;font-weight:bold;">stringEscapeRegex</span>, <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">stringEscapeFn</span>) + <span style="color:#008000;font-weight:bold;">'</span><span style="color:#000080;font-weight:bold;">\'</span><span style="color:#008000;font-weight:bold;">'</span>;<br/>
    }<span style="color:#000080;font-weight:bold;">else</span>{<br/>
        <span style="color:#000080;font-weight:bold;">return </span>value;<br/>
    }</div>
<div><span style="font-size: 12pt;"><span style="font-family: Menlo;">};</span></span></div>
<div style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:12.0pt;"><span style="font-style:italic;">ASTCompiler</span>.<span style="color:#7a7a43;">prototype</span>.<span style="color:#660e7a;font-weight:bold;">stringEscapeRegex </span>= <span style="color:#0000ff;">/[^ a-zA-Z0-9]/g</span>;<br/>
<span style="font-style:italic;">ASTCompiler</span>.<span style="color:#7a7a43;">prototype</span>.<span style="color:#7a7a43;">stringEscapeFn </span>= <span style="color:#000080;font-weight:bold;">function</span>(c){<br/>
    <span style="color:#000080;font-weight:bold;">return </span><span style="color:#008000;font-weight:bold;">'</span><span style="color:#000080;font-weight:bold;">\\</span><span style="color:#008000;font-weight:bold;">u'</span>+(<span style="color:#008000;font-weight:bold;">'0000'</span>+ c.<span style="color:#7a7a43;">charCodeAt</span>(<span style="color:#0000ff;">0</span>).<span style="color:#7a7a43;">toString</span>(<span style="color:#0000ff;">16</span>)).<span style="color:#7a7a43;">slice</span>(-<span style="color:#0000ff;">4</span>);<br/>
    <span style="color:#808080;font-style:italic;">//get the numeric unicode value, and convert it into corresponding hexadecimal unicode escape sequence</span></div>
<div><span style="font-size: 12pt;"><span style="font-family: Menlo;">};</span></span></div>
<div title="Page 190">5，解析true, false, null</div>
<div title="Page 190">这些单词称为identifier tokens</div>
<div title="Page 190">6，解析空白，几乎全部空白都可以忽略</div>
<div title="Page 190">7，解析数组，空白数组解析为[]，</div>
<div title="Page 190">Lexer直接作为text解析成token，将[,],逗号隔开的元素push进tokens</div>
<div title="Page 190">AST增加expect函数，因为现在需要处理多个tokens，expect检查下一个token是不是我们所期望的，如果是的话就return，并且从this.tokens中移除该token，方便向下解析。</div>
<div title="Page 190">增加arrayDeclaration函数，调用consume方法吸收和数组有关的tokens并且构造对应的数组AST节点。consume函数和expect函数差不多，但是如果一个对应的token没找到的话consume函数会抛出一个异常。</div>
<div title="Page 190">增加一个新的节点type: AST.ArrayExpression，然后交给Compiler。</div>
<div title="Page 190">8，解析object</div>
<div title="Page 190">和解析数组一个道理，先读出所有的key, value，然后压到一个properties数组里，组成一个type: AST.ObjectExpression的对象，交给Compiler。Compiler取出每个key, value对，key作escape，value做recurse，返回 key+”:”+value;</div>
<div title="Page 190"><br/></div>
<div title="Page 190">总结：</div>
<ol>
<li title="Page 190">expression parser的三个阶段： Lexing, AST building, AST compilation</li>
<li title="Page 190">parsing的结果是一个javascript function</li>
<li title="Page 190">如何解析各个对象</li>
</ol>
<div title="Page 190"><br/></div>
<div title="Page 190">第六章：Lookup and function call expressions</div>
<div title="Page 190">给Angular expression language增加accessing data on scopes和manipulating data的功能，包括access and assign attributes, call functions, security measures等等</div>
<div style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:12.0pt;">it(<span style="color:#008000;font-weight:bold;">'looks up an attribute from the scope'</span>, <span style="color:#000080;font-weight:bold;">function</span>() {<br/>
    <span style="color:#000080;font-weight:bold;">var </span><span style="color:#458383;">fn </span>= <span style="color:#660e7a;font-weight:bold;font-style:italic;">parse</span>(<span style="color:#008000;font-weight:bold;">'aKey'</span>);<br/>
    expect(<span style="color:#458383;">fn</span>({<span style="color:#660e7a;font-weight:bold;">aKey</span>: <span style="color:#0000ff;">42</span>})).<span style="font-style:italic;">toBe</span>(<span style="color:#0000ff;">42</span>);<br/>
    expect(<span style="color:#458383;">fn</span>({})).<span style="font-style:italic;">toBeUndefined</span>();</div>
<div><span style="font-size: 12pt;"><span style="font-family: Menlo;">});</span></span></div>
<div><br/></div>
<div>这里传给fn的是一个object，实际应用中几乎肯定是一个scope对象。’aKey'被解析成一个identifier token，然后变成一个Identifier AST node。现在我们要添加attribute lookup的支持。</div>
<div title="Page 190">compile中new Function添加一个参数s，变成return (s).xxx;，这样通过上面这个unit test。</div>
<div title="Page 190">AngularJS对于undefined比较宽容，引用不存在的object attribute一般不会抛出exception，所以lookup之前需要先判断是否是undefined。在解析的时候会引入临时变量，变成类似'var v1;if(s){v1=(s).anObject;}return v1;’的形式</div>
<div title="Page 190">var hoisting: declaring a variable anywhere in the code is equivalent to declaring it at the top. 变量声明的位置不重要。所以可以一次性声明完解析过程中所需的全部变量。</div>
<div title="Page 190"><br/></div>
<div title="Page 190">到解析object为止，AST节点的Type：</div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">AST</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">Program </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">= </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">Program</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">;<br/></span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">AST</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">Literal </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">= </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">Literal</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">;<br/></span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">AST</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">ArrayExpression </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">= </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">ArrayExpression</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">;<br/></span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">AST</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">ObjectExpression </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">= </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">ObjectExpression</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">;<br/></span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">AST</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">Property </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">= </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">Property</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">;<br/></span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">AST</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">Identifier </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">= </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">Identifier</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">;<br/></span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">AST</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">ThisExpression </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">= </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">ThisExpression</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">;</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">AST</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">MemberExpression </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">= </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">MemberExpression</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)"> </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">;</span></div>
<div title="Page 190">解析A.B：关于.符号</div>
<div><br/></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">if</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">this</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">expect</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">.</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">)) { primary = {</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(56.000000%, 13.000000%, 0.000000%)">type</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">:</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">AST</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">MemberExpression</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">,</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(56.000000%, 13.000000%, 0.000000%)">object</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">: primary,</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(56.000000%, 13.000000%, 0.000000%)">property</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">:</span> <span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">this</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">identifier</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">()</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'">}; }</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">return</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">primary;</span></div>
<div title="Page 190"><br/></div>
<div title="Page 190">复用primary node作为新的primary node的object member，实现关于.的look up</div>
<div title="Page 190">如果有三个以上的点怎么办？例如A.B.C，trick：改成while循环，while (this.expect(‘.’))，重复地复用。</div>
<div title="Page 190">最后被解析出来的形式类似于：</div>
<div>
<p><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">function</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(s) {<br/></span><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">var</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">v0, v1, v2, v3;</span> <span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">if</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">(s) {</span></p>
<p><span style="font-size: 9.000000pt; font-family: 'LMMono9'">v3 =</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">s</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">aKey</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">; }</span></p>
<p><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">if</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">(v3) {</span></p>
<pre>
<span style="font-size: 9.000000pt; font-family: 'LMMono9'">    v2 = </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">v3</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">secondKey</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">;
  }
</span>
</pre>
<p><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">if</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">(v2) {</span></p>
<pre>
<span style="font-size: 9.000000pt; font-family: 'LMMono9'">    v1 = </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">v2</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">thirdKey</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">;
  }
</span>
</pre>
<p><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">if</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">(v1) {</span></p>
<pre>
<span style="font-size: 9.000000pt; font-family: 'LMMono9'">    v0 = </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">v1</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">fourthKey</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">;
  }
</span>
</pre></div>
<div><br/></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">return</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">v0; }</span></div>
<div title="Page 190"><br/></div>
<div title="Page 190">到目前为止parse函数只有一个参数scope ’s'，现在添加一个argument叫做locals ‘l'，parsed expressions应该先从locals object进行look up，然后再去scope找。这样做的作用是可以使得一些属性对于表达式可用，但不用把它们和scope进行绑定。例如 ngClick directive，是和$event绑定的</div>
<div><br/></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">it</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">uses locals instead of scope when there is a matching key</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">,</span> <span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">function</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">() {</span></div>
<div style="margin-left:40px;"><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">var</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">fn =</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">parse</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">aKey</span><span style="font-family: LMMono9;"><span style="font-size: 9pt;">);</span></span></div>
<div style="margin-left:40px;"><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">var</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">scope = {</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(56.000000%, 13.000000%, 0.000000%)">aKey</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">:</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 63.000000%, 44.000000%)">42</span><span style="font-family: LMMono9;"><span style="font-size: 9pt;">};</span></span></div>
<div style="margin-left:40px;"><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">var</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">locals = {</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(56.000000%, 13.000000%, 0.000000%)">aKey</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">:</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 63.000000%, 44.000000%)">43</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">};</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">           expect</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">fn</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(scope, locals)).</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">toBe</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 63.000000%, 44.000000%)">43</span><span style="font-family: LMMono9;"><span style="font-size: 9pt;">);</span></span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'">});<br/></span></div>
<div title="Page 190">解析了之后现在’l’中找有无该属性，如果没有则去’s’中找。下面是拼出代码的实现：</div>
<div title="Page 190">
<div style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:12.0pt;"><span style="color:#000080;font-weight:bold;">case </span><span style="font-style:italic;">AST</span>.<span style="color:#660e7a;font-weight:bold;">Identifier</span>:<br/>
    <span style="color:#000080;font-weight:bold;">var </span><span style="color:#458383;">intoId </span>= <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">nextId</span>();<br/>
    <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">if_</span>(<span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">getHasOwnProperty</span>(<span style="color:#008000;font-weight:bold;">'l'</span>, ast.<span style="color:#7a7a43;">name</span>),<br/>
        <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">assign</span>(<span style="color:#458383;">intoId</span>, <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">nonComputedMember</span>(<span style="color:#008000;font-weight:bold;">'l'</span>, ast.<span style="color:#7a7a43;">name</span>))); <span style="color:#808080;font-style:italic;">//if (s){ v0=...; } return v0;<br/></span><span style="color:#808080;font-style:italic;">   </span> <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">if_</span>(<span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">not</span>(<span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">getHasOwnProperty</span>(<span style="color:#008000;font-weight:bold;">'l'</span>, ast.<span style="color:#7a7a43;">name</span>))+<span style="color:#008000;font-weight:bold;">' &amp;&amp;s'</span>,<br/>
        <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">assign</span>(<span style="color:#458383;">intoId</span>, <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">nonComputedMember</span>(<span style="color:#008000;font-weight:bold;">'s'</span>, ast.<span style="color:#7a7a43;">name</span>)));<br/>
    <span style="color:#000080;font-weight:bold;">return </span><span style="color:#458383;">intoId</span>;<br/></div>
</div>
<div title="Page 190"><br/></div>
<div title="Page 190">关于computed attribute lookup:</div>
<div title="Page 190">non-computed lookup：access attributes on scoped using dot operator</div>
<div title="Page 190">computed attribute lookup: using square bracket notation，aKey[anotherKey]，computed的意思是 itself looked up from the scope or computed in some other way，中括号内可以是变量</div>
<div title="Page 190">computed attribute lookup解析出来的函数是：</div>
<div title="Page 190">LOG:</div>
<div title="Page 190">'var v1,v2,v3,v4;if(l&amp;&amp;('lock' in l)){v2=(l).lock;}if(!(l&amp;&amp;('lock' in l)) &amp;&amp;s){v2=(s).lock;}if(l&amp;&amp;('keys' in l)){v4=(l).keys;}if(!(l&amp;&amp;('keys' in l)) &amp;&amp;s){v4=(s).keys;}if(v4){v3=(v4)['aKey'];}if(v2){v1=(v2)[v3];}return v1;'</div>
<div title="Page 190"><br/></div>
<div title="Page 190">关于Function call：</div>
<div title="Page 190">1，寻找function，2，添加括号来调用函数，其实与object lookup并无明显区别</div>
<div title="Page 190">Function call需要支持参数，先解析括号之间的参数，recurse每个参数并将结果放到数组里，然后返回 callee +  &amp;&amp;  + callee +  (  + args.join( , ) +  ) ;</div>
<div title="Page 190"><br/></div>
<div title="Page 190">method call：When a function is attached to an object as an attribute and invoked by first dereferencing it from the object using a dot or square brackets, the function is invoked as a method. 类似于object.method()（noncomputed）或者 anObject[“anMethod”]()（computed）</div>
<div title="Page 190">相关的解析工作在AST compiler中做，在recurse函数中增加CallExpression分支，使得this指向原先Angular expression指向的对象。</div>
<div title="Page 190">引入一个”call context”对象，保存了这个method call相关的上下文信息。</div>
<div title="Page 190">recurse函数增加context参数，传入method call之后，context会增加三个属性：1, context，方法的owning object，最终称为this，2，name，该方法的属性名，3，computed，是否是computed property</div>
<div title="Page 190"><br/></div>
<div title="Page 190">对于standalone function来说，this指的是scope，对于和局部变量绑定的function，this指的是locals，也需要解析出来。这个是在recurse中的Identifier分支，context要么是’l’要么是’s'</div>
<div title="Page 190"><br/></div>
<div title="Page 190">assigning values：解析assignments，也就是put data on scopes。assign不仅可赋值给identifiers，也可以给computed and non computed properties。</div>
<div title="Page 190">Assignment不是之前的”primary” AST node，新建一个函数assignment。先解析等号左边的token，这是一个primary node，然后解析右边的primary node。</div>
<div>
<p><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">AST</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">prototype</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">assignment</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">=</span> <span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">function</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">() {</span> <span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">var</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">left =</span> <span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">this</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">primary</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">();<br/></span><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">if</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">this</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">expect</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">=</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">)) {</span></p>
<p><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">var</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">right =</span> <span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">this</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">primary</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">();</span></p>
<p><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">return</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">{</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(56.000000%, 13.000000%, 0.000000%)">type</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">:</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">AST</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">AssignmentExpression</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">,</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(56.000000%, 13.000000%, 0.000000%)">left</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">: left,</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(56.000000%, 13.000000%, 0.000000%)">right</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">: right}; }</span></p>
</div>
<div><br/></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">return</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">left; };</span></div>
<div title="Page 190"><br/></div>
<div title="Page 190">因为assignment当没有等号的时候等效于primary，所以将一些可能出现assignment的地方，原来的primary()替换成assignment()</div>
<div title="Page 190">ASTCompiler的解析：</div>
<div style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:12.0pt;"><span style="color:#000080;font-weight:bold;">case </span><span style="font-style:italic;">AST</span>.<span style="color:#660e7a;font-weight:bold;">AssignmentExpression</span>:<br/>
    <span style="color:#000080;font-weight:bold;">var </span><span style="color:#458383;">leftContext </span>= {};<br/>
    <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">recurse</span>(ast.<span style="color:#660e7a;font-weight:bold;">left</span>, <span style="color:#458383;">leftContext</span>);<br/>
    <span style="color:#000080;font-weight:bold;">var </span><span style="color:#458383;">leftExpr</span>;<br/>
    <span style="color:#000080;font-weight:bold;">if </span>(<span style="color:#458383;">leftContext</span>.<span style="color:#660e7a;font-weight:bold;">computed</span>){<br/>
        <span style="color:#458383;">leftExpr </span>= <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">computedMember</span>(<span style="color:#458383;">leftContext</span>.<span style="color:#7a7a43;">context</span>, <span style="color:#458383;">leftContext</span>.<span style="color:#7a7a43;">name</span>);<br/>
    }<br/>
    <span style="color:#000080;font-weight:bold;">else</span>{<br/>
        <span style="color:#458383;">leftExpr </span>= <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">nonComputedMember</span>(<span style="color:#458383;">leftContext</span>.<span style="color:#7a7a43;">context</span>, <span style="color:#458383;">leftContext</span>.<span style="color:#7a7a43;">name</span>);<br/>
    }</div>
<div><span style="font-size: 12pt;"><span style="font-family: Menlo;">    <span style="color:#000080;font-weight:bold;">return this</span>.<span style="color:#7a7a43;">assign</span>(<span style="color:#458383;">leftExpr</span>, <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#7a7a43;">recurse</span>(ast.<span style="color:#660e7a;font-weight:bold;">right</span>));</span></span></div>
<div title="Page 190"><br/></div>
<div title="Page 190">Angular expressions的nested assignment的一个有趣特性：如果赋值给路径中不存在的object，则这些对象会被创建。解决办法：recurse添加一个新的布尔值参数，决定是否创建可能有的新的对象。</div>
<div title="Page 190">安全性保证：</div>
<div title="Page 190">1, Member access</div>
<div title="Page 190">Function的 constructor attribute有可能被攻击者利用，例如 aFunction.constructor("return window;")()。以及其他一些可能被利用的issues，如__proto__，__defineGetter__, __lookupGetter__, __defineSetter__, and __lookupSetter__等等。Angular需要disallow这些属性在expression中的访问。</div>
<div title="Page 190">对于non-computed member access在AST Compiler里面注意name，如果碰到非法name直接抛出错误。而对于computed member access，因为在parse time我们不知道属性名字，所以需要在runtime的时候调用ensureSafeMemberName函数。</div>
<div title="Page 190">2, Ensuring safe objects</div>
<div title="Page 190">一些object调用也比较危险，如 <u>window 和 DOM元素，以及function constructor，和Object 对象</u>，调用window的alias也应当被抛出错误，如anObject.wnd应该抛出错误。并且unsafe object也不应当允许作为参数使用。</div>
<div title="Page 190"><br/></div>
<div title="Page 190">静态parse time检查：</div>
<div>
<div style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:12.0pt;"><span style="color:#000080;font-weight:bold;">function </span><span style="font-style:italic;">ensureSafeMemberName</span>(name){<br/>
    <span style="color:#000080;font-weight:bold;">if </span>(name===<span style="color:#008000;font-weight:bold;">'constructor' </span>|| name ===  <span style="color:#008000;font-weight:bold;">'__proto__' </span>||<br/>
        name === <span style="color:#008000;font-weight:bold;">'__defineGetter__' </span>|| name === <span style="color:#008000;font-weight:bold;">'__defineSetter__'</span>||<br/>
        name === <span style="color:#008000;font-weight:bold;">'__lookupGetter__' </span>|| name === <span style="color:#008000;font-weight:bold;">'__lookupSetter__'</span>) {<br/>
        <span style="color:#000080;background-color:#e4e4ff;font-weight:bold;">throw </span><span style="color:#008000;background-color:#e4e4ff;font-weight:bold;">'Attempting to access a disallowed field in Angular expressions!'</span><span style="background-color:#e4e4ff;">;</span><br/>
    }<br/>
<span style="background-color:#e4e4ff;">}</span><br/>
<br/>
<span style="color:#000080;font-weight:bold;">function </span><span style="font-style:italic;">ensureSafeObject</span>(obj){<br/>
    <span style="color:#000080;font-weight:bold;">if </span>(obj){<br/>
        <span style="color:#000080;font-weight:bold;">if </span>(obj.<span style="color:#660e7a;font-weight:bold;">window </span>=== obj){<br/>
            <span style="color:#000080;font-weight:bold;">throw </span><span style="color:#008000;font-weight:bold;">'Referencing window in Angular expressions is disallowed!'</span>;<br/>
        } <span style="color:#000080;font-weight:bold;">else if </span>(obj.<span style="color:#7a7a43;">children </span>&amp;&amp; (obj.<span style="color:#7a7a43;">nodeName </span>|| (obj.<span style="color:#7a7a43;">prop </span>&amp;&amp; obj.<span style="color:#7a7a43;">attr </span>&amp;&amp; obj.<span style="color:#660e7a;font-weight:bold;font-style:italic;">find</span>))){<br/>
            <span style="color:#000080;font-weight:bold;">throw </span><span style="color:#008000;font-weight:bold;">'Referencing DOM nodes in Angular expressions is disallowed!'</span>;<br/>
        } <span style="color:#000080;font-weight:bold;">else if </span>(obj.<span style="color:#7a7a43;">constructor </span>=== obj){<br/>
            <span style="color:#000080;font-weight:bold;">throw </span><span style="color:#008000;font-weight:bold;">'Referencing Function in Angular expressions is disallowed!'</span>;<br/>
        }<span style="color:#000080;font-weight:bold;">else if </span>(obj === Object){<br/>
            <span style="color:#000080;font-weight:bold;">throw </span><span style="color:#008000;font-weight:bold;">'Referencing Object in Angular expressions is disallowed!'</span>;<br/>
        }<br/>
    }<br/>
    <span style="color:#000080;font-weight:bold;">return </span>obj;<br/>
}<br/></div>
</div>
<div title="Page 190">动态runtime检查：</div>
<div style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:12.0pt;"><br/>
<span style="font-style:italic;">ASTCompiler</span>.<span style="color:#7a7a43;">prototype</span>.<span style="color:#7a7a43;">addEnsureSafeMemberName </span>= <span style="color:#000080;font-weight:bold;">function</span>(expr){<br/>
    <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#660e7a;font-weight:bold;">state</span>.<span style="color:#660e7a;font-weight:bold;">body</span>.<span style="color:#7a7a43;">push</span>(<span style="color:#008000;font-weight:bold;">'ensureSafeMemberName('</span>+expr+<span style="color:#008000;font-weight:bold;">');'</span>);<br/>
};<br/>
<br/>
<span style="font-style:italic;">ASTCompiler</span>.<span style="color:#7a7a43;">prototype</span>.<span style="color:#7a7a43;">addEnsureSafeMemberName </span>= <span style="color:#000080;font-weight:bold;">function</span>(expr){<br/>
    <span style="color:#000080;font-weight:bold;">this</span>.<span style="color:#660e7a;font-weight:bold;">state</span>.<span style="color:#660e7a;font-weight:bold;">body</span>.<span style="color:#7a7a43;">push</span>(<span style="color:#008000;font-weight:bold;">'ensureSafeObject('</span>+expr+<span style="color:#008000;font-weight:bold;">');'</span>);<br/>
};</div>
<div><br/></div>
<div title="Page 190">3，Ensuring Safe Functions</div>
<div title="Page 190">Angular希望阻止rebind，即访问call和apply（也就是bind）方法。这样可以防止injection attack</div>
<div title="Page 190"><br/></div>
<div style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:12.0pt;"><span style="color:#000080;font-weight:bold;">var </span><span style="color:#660e7a;font-weight:bold;font-style:italic;">CALL </span>= <span style="color:#660e7a;font-weight:bold;">Function</span>.<span style="color:#7a7a43;">prototype</span>.<span style="color:#7a7a43;">call</span>;<br/>
<span style="color:#000080;font-weight:bold;">var </span><span style="color:#660e7a;font-weight:bold;font-style:italic;">APPLY </span>= <span style="color:#660e7a;font-weight:bold;">Function</span>.<span style="color:#7a7a43;">prototype</span>.<span style="color:#7a7a43;">apply</span>;</div>
<div><span style="font-size: 12pt;"><span style="font-family: Menlo;"><span style="color:#000080;font-weight:bold;">var </span><span style="color:#660e7a;font-weight:bold;font-style:italic;">BIND </span>= <span style="color:#660e7a;font-weight:bold;">Function</span>.<span style="color:#7a7a43;">prototype</span>.<span style="color:#7a7a43;">bind</span>;</span></span></div>
<div style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:12.0pt;"><span style="color:#000080;font-weight:bold;">function </span><span style="font-style:italic;">ensureSafeFunction</span>(obj){<br/>
    <span style="color:#000080;font-weight:bold;">if </span>(obj){<br/>
        <span style="color:#000080;font-weight:bold;">if </span>(obj.<span style="color:#7a7a43;">constructor </span>=== obj){<br/>
            <span style="color:#000080;font-weight:bold;">throw </span><span style="color:#008000;font-weight:bold;">'Referencing Function in Angular expressions is disallowed!'</span>;<br/>
        } <span style="color:#000080;font-weight:bold;">else if </span>(obj===<span style="color:#660e7a;font-weight:bold;font-style:italic;">CALL </span>|| obj===<span style="color:#660e7a;font-weight:bold;font-style:italic;">APPLY </span>|| obj===<span style="color:#660e7a;font-weight:bold;font-style:italic;">BIND</span>){<br/>
            <span style="color:#000080;font-weight:bold;">throw </span><span style="color:#008000;font-weight:bold;">'Referencing call, apply, or bind in Angular expressions is disallowed!' </span>;<br/>
        }<br/>
    }<br/>
    <span style="color:#000080;font-weight:bold;">return </span>obj;<br/>
}<br/></div>
<div title="Page 190"><br/></div>
<div title="Page 190">总结：</div>
<ol>
<li title="Page 190">computed and non-computed attribute的lookup</li>
<li title="Page 190">locals，可以覆盖scope attributes</li>
<li title="Page 190">function calls的解析</li>
<li title="Page 190">this context的解析</li>
<li title="Page 190">安全措施，包括Function constructor, potentially dangerous objects, function call</li>
<li title="Page 190">关于assignment的解析，simple attribute和nested attribute</li>
<li title="Page 190">Angular expression的forgiving nature，missing attributes不抛出exception，而是新建这个attribute</li>
</ol>
<div title="Page 190"><br/></div>
<div title="Page 190"><br/></div>
<div title="Page 190"><br/></div>
<div title="Page 190"><br/></div>
<div title="Page 190"><br/></div>
<div title="Page 190"><br/></div>
<div title="Page 190"><br/></div>
<div title="Page 190"><br/></div>
<div title="Page 190"><br/></div>
<div title="Page 190"><br/></div>
</body></html>