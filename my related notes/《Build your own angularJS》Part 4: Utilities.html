<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.0.16 (451861)"/><meta name="altitude" content="13.90636539459229"/><meta name="author" content="markselby"/><meta name="created" content="2016-01-27 02:26:50 +0000"/><meta name="latitude" content="31.19382950908968"/><meta name="longitude" content="121.5955277535859"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2016-02-01 13:42:45 +0000"/><title>《Build your own angularJS》Part 4: Utilities</title></head><body>
<div>Chapter 13: Promises</div>
<div>Javascript的asynchronous computation：callback functions</div>
<div>缺点：1，business logic和实现细节被混在一起，2，control flow太复杂，pyramid of doom的问题，3，关于错误的处理没有已有的方式，都是依赖于一个特殊的error arguments in callbacks。</div>
<div><br/></div>
<div>Promises：解决上述问题的尝试。一个将未来的asynchronous call的结果绑定到一个object上的机制，promise object控制了当一个函数的有了结果之后给你对这个value的access。使用Promise时函数不会将callback作为参数，而是返回一个Promise来接受这个callback。</div>
<div>promise支持then的chaining，catch方法用来处理错误，errors也可以通过promise chain进行传播，</div>
<div><span style="font: 9.0px Helvetica"><br/></span><span style="font: 9.0px Monaco; color: #05297d">computeBalance</span><span style="font: 9.0px Monaco">(a, b)<br/>
  .</span><span style="font: 9.0px Monaco; color: #05297d">then</span><span style="font: 9.0px Monaco">(storeBalance)<br/>
  .</span><span style="font: 9.0px Monaco; color: #05297d">then</span><span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-size: 9px;"><span style="font-family: Monaco;">(displayResults)</span></span></span></div>
<div><span style="font-family: Monaco;"><span style="font-size: 9px;">  .<span style="font: 9.0px Monaco; color: #05297d">catch</span><span style="font: 9.0px Monaco">(handleError);</span></span></span></div>
<div><br/></div>
<div>AngularJS内置的service是$q，和其他的promise实现的区别是$q是和digest loop关联的，$q可以使用$evalAsync而不是setTimeout。</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%204%3A%20Utilities.resources/D875FD50-161A-462B-B172-413DEBA7461F.png" height="508" width="1208"/></div>
<div>deferred: computation that makes that value available，创建一个deferred对象时也就创建了一个promise</div>
<div><br/></div>
<div>resolve a deferred：promise内部的$$state变量记录callback函数相关的pending, value等变量</div>
<div>When we have a Deferred and a Promise, we can attach a callback on the Promise. Then, after the Deferred is resolved to a value, the callback on the Promise will at some point in the future get invoked with that value.</div>
<div>resolve和给promise注册callback的顺序不需要严格先后，promise callbacks在resolving the Deferred之后的下一个digest被调用。$rootScope.$evalAsync，需要在$QProvider inject一个$rootScope。</div>
<div><br/></div>
<div>Deferred的一个重要feature是只会被resolve一次，如果试图resolve第二次则对应的调用会被忽略，实现方式是resolved时内部的$$state记录$$state.status=1，如果resolve的时候status已经是1则立刻return</div>
<div><br/></div>
<div>确保callback会被调用：此时如果一个callback在一个deferred已经被resolved之后，且一个digest已经运行了之后才注册，则这个callback应该也要被调用。实现是在then方法（注册callback）中判断status，如果大于0则进行一次scheduleProcessQueue。</div>
<div><br/></div>
<div>一个Deferred有且只有一个Promise，但是一个Promise应当可以有多个callback。实现是将pending改成数组。注意为了确保每个callback只被调用一次，当进入processQueue时候需要将pending数组保存在临时变量，然后清空state.pending，这样当之后有新的callback的时候再reinitialize。</div>
<div><br/></div>
<div>rejecting deferred：关于error handling的解决，1，需要有办法能够signal一个Deferred，告诉它有事情不对，这是rejecting the Deferred，2，需要有办法让Deferred在一个rejection发生的时候被notified。实现的时候给then增加第二个参数，作为被reject的时候的callback。</div>
<div>一个Promise最多被reject一次，一个promise一旦被reject了之后就不能再次resolve，一个promise只会有一个outcome，要么是resolution要么是rejection。</div>
<div>实现和resolve很相似，主要是status不同，rejected是2.然后pending数组里面放的不是单个函数了，而是数组，[null, onFulfilled, onRejected]，根据status选择callback。</div>
<div><br/></div>
<div>finally：和try...catch...finally相似，finally方法参数是一个callback，主要用来在asynchronous work之后做cleanup work，在这个promise被resolve之后被调用，不接受任何参数。实现方法是当做一个有同样的success和failure callback的then方法，不论如何都被调用。</div>
<div><br/></div>
<div>promise chaining：</div>
<div><span style="font: 9.0px Monaco; color: #05297d">it</span><span style="font: 9.0px Monaco">(</span> <span style="font: 9.0px Monaco; color: #4071a0">does not modify original resolution in chains</span> <span style="font: 9.0px Monaco">,</span> <span style="font: 9.0px Monaco; color: #017121">function</span><span style="font: 9.0px Monaco">() {</span> <span style="font: 9.0px Monaco; color: #017121">var</span> <span style="font: 9.0px Monaco">d =</span> <span style="font: 9.0px Monaco; color: #017121">$q</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">defer</span><span style="font: 9.0px Monaco">();<br/></span><span style="font: 9.0px Monaco; color: #017121">var</span> <span style="font: 9.0px Monaco">fulfilledSpy =</span> <span style="font: 9.0px Monaco; color: #017121">jasmine</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">createSpy</span><span style="font: 9.0px Monaco">();<br/></span><span style="font: 9.0px Monaco; color: #017121">d</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #017121">promise</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">then</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">function</span><span style="font: 9.0px Monaco">(result) {</span> <span style="font: 9.0px Monaco; color: #017121">return</span> <span style="font: 9.0px Monaco">result +</span> <span style="font: 9.0px Monaco; color: #40a070">1</span><span style="font: 9.0px Monaco">;<br/>
}).</span><span style="font: 9.0px Monaco; color: #05297d">then</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">function</span><span style="font: 9.0px Monaco">(result) {</span> <span style="font: 9.0px Monaco; color: #017121">return</span> <span style="font: 9.0px Monaco">result *</span> <span style="font: 9.0px Monaco; color: #40a070">2</span><span style="font: 9.0px Monaco">;<br/>
  });<br/></span><span style="font: 9.0px Monaco; color: #017121">  d</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #017121">promise</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">then</span><span style="font: 9.0px Monaco">(fulfilledSpy);<br/></span><span style="font: 9.0px Monaco; color: #017121">  d</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">resolve</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #40a070">20</span><span style="font: 9.0px Monaco">);<br/></span><span style="font: 9.0px Monaco; color: #017121">  $rootScope</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">$apply</span><span style="font: 9.0px Monaco">();<br/></span><span style="font: 9.0px Monaco; color: #05297d">  expect</span><span style="font: 9.0px Monaco">(fulfilledSpy).</span><span style="font: 9.0px Monaco; color: #05297d">toHaveBeenCalledWith</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #40a070">20</span><span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-size: 9px;"><span style="font-family: Monaco;">);</span></span></span></div>
<div><span style="font-size: 9px;"><span style="font-family: Monaco;">});</span></span></div>
<div>实际发生的事情是每个then方法都返回了另外一个new Promise object，用来做further callbacks。因为是new Promise，所以原先Promise上其他的callback都不受影响。</div>
<div>实现：每次then返回一个新的Deferred对象的promise, 然后需要把这个Deferred传递给onFulfilled callback实际上被调用的地方，这样结果可以被传递下去。pending数组改成[result, onFulfilled, onRejected]，然后每次processQueue的时候将callback的结果返回给这个Deferred对象。</div>
<div><span style="font: 9.0px Monaco; color: #017121">function</span> <span style="font: 9.0px Monaco; color: #05297d">processQueue</span><span style="font: 9.0px Monaco">(state) {<br/></span><span style="font: 9.0px Monaco; color: #017121">var</span> <span style="font: 9.0px Monaco">pending =</span> <span style="font: 9.0px Monaco; color: #017121">state</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">pending</span><span style="font: 9.0px Monaco">;<br/></span><span style="font: 9.0px Monaco; color: #017121">delete state</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">pending</span><span style="font: 9.0px Monaco">;</span> <span style="font: 9.0px Monaco; color: #017121">_</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">forEach</span><span style="font: 9.0px Monaco">(pending,</span> <span style="font: 9.0px Monaco; color: #017121">function</span><span style="font: 9.0px Monaco">(handlers) {<br/></span><span style="font: 9.0px Monaco; color: #017121">var</span> <span style="font: 9.0px Monaco">deferred = handlers[</span><span style="font: 9.0px Monaco; color: #40a070">0</span><span style="font: 9.0px Monaco">];<br/></span><span style="font: 9.0px Monaco; color: #017121">var</span> <span style="font: 9.0px Monaco">fn = handlers[</span><span style="font: 9.0px Monaco; color: #017121">state</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">status</span><span style="font: 9.0px Monaco">];</span> <span style="font: 9.0px Monaco; color: #017121">if</span> <span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">_</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">isFunction</span><span style="font: 9.0px Monaco">(fn)) {<br/></span><span style="font: 9.0px Monaco; color: #017121">      deferred</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">resolve</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #05297d">fn</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">state</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">value</span><span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-size: 9px;"><span style="font-family: Monaco;">));<br/>
    }</span></span></span></div>
<div><span style="font-size: 9px;"><span style="font-family: Monaco;">}); }</span></span></div>
<div>每个新的Deferred对象都是和原来的Deferred对象独立的，但是他们都是在原来的对象被resolved的时候才被resolved。</div>
<div>chains的另外一个重要性质是一个value会被传递直到一个callback handler。比如</div>
<div><span style="font: 9.0px Monaco; color: #05297d">it</span><span style="font: 9.0px Monaco">(</span> <span style="font: 9.0px Monaco; color: #4071a0">catches rejection on chained handler</span> <span style="font: 9.0px Monaco">,</span> <span style="font: 9.0px Monaco; color: #017121">function</span><span style="font: 9.0px Monaco">() {</span> <span style="font: 9.0px Monaco; color: #017121">var</span> <span style="font: 9.0px Monaco">d =</span> <span style="font: 9.0px Monaco; color: #017121">$q</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">defer</span><span style="font: 9.0px Monaco">();<br/></span><span style="font: 9.0px Monaco; color: #017121">var</span> <span style="font: 9.0px Monaco">rejectedSpy =</span> <span style="font: 9.0px Monaco; color: #017121">jasmine</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">createSpy</span><span style="font: 9.0px Monaco">();</span> <span style="font: 9.0px Monaco; color: #017121">d</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #017121">promise</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">then</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">_</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">noop</span><span style="font: 9.0px Monaco">).</span><span style="font: 9.0px Monaco; color: #05297d">catch</span><span style="font: 9.0px Monaco">(rejectedSpy);<br/></span><span style="font: 9.0px Monaco; color: #017121">  d</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">reject</span><span style="font: 9.0px Monaco">(</span> <span style="font: 9.0px Monaco; color: #4071a0">fail</span> <span style="font: 9.0px Monaco">);<br/></span><span style="font: 9.0px Monaco; color: #017121">  $rootScope</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">$apply</span><span style="font: 9.0px Monaco">();<br/></span><span style="font: 9.0px Monaco; color: #05297d">  expect</span><span style="font: 9.0px Monaco">(rejectedSpy).</span><span style="font: 9.0px Monaco; color: #05297d">toHaveBeenCalledWith</span><span style="font: 9.0px Monaco">(</span> <span style="font: 9.0px Monaco; color: #4071a0">fail</span> <span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-size: 9px;"><span style="font-family: Monaco;">);</span></span></span></div>
<div><span style="font-size: 9px;"><span style="font-family: Monaco;">});</span></span></div>
<div>实现是在processQueue方法里，根据当前的status，resolve or reject the chained Deferred with the current Promise’s value。</div>
<div><span style="font: 9.0px Monaco; color: #017121">function</span> <span style="font: 9.0px Monaco; color: #05297d">processQueue</span><span style="font: 9.0px Monaco">(state) {<br/></span><span style="font: 9.0px Monaco; color: #017121">var</span> <span style="font: 9.0px Monaco">pending =</span> <span style="font: 9.0px Monaco; color: #017121">state</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">pending</span><span style="font: 9.0px Monaco">;<br/></span><span style="font: 9.0px Monaco; color: #017121">delete state</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">pending</span><span style="font: 9.0px Monaco">;</span> <span style="font: 9.0px Monaco; color: #017121">_</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">forEach</span><span style="font: 9.0px Monaco">(pending,</span> <span style="font: 9.0px Monaco; color: #017121">function</span><span style="font: 9.0px Monaco">(handlers) {<br/></span><span style="font: 9.0px Monaco; color: #017121">var</span> <span style="font: 9.0px Monaco">deferred = handlers[</span><span style="font: 9.0px Monaco; color: #40a070">0</span><span style="font: 9.0px Monaco">];<br/></span><span style="font: 9.0px Monaco; color: #017121">var</span> <span style="font: 9.0px Monaco">fn = handlers[</span><span style="font: 9.0px Monaco; color: #017121">state</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">status</span><span style="font: 9.0px Monaco">];</span> <span style="font: 9.0px Monaco; color: #017121">if</span> <span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">_</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">isFunction</span><span style="font: 9.0px Monaco">(fn)) {<br/></span><span style="font: 9.0px Monaco; color: #017121">deferred</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">resolve</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #05297d">fn</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">state</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">value</span><span style="font: 9.0px Monaco">)); }</span> <span style="font: 9.0px Monaco; color: #017121">else if</span> <span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">state</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">status</span> <span style="font: 9.0px Monaco">===</span> <span style="font: 9.0px Monaco; color: #40a070">1</span><span style="font: 9.0px Monaco">) {</span> <span style="font: 9.0px Monaco; color: #017121">deferred</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">resolve</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">state</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">value</span><span style="font: 9.0px Monaco">);<br/>
}</span> <span style="font: 9.0px Monaco; color: #017121">else</span> <span style="font: 9.0px Monaco">{<br/></span><span style="font: 9.0px Monaco; color: #017121">      deferred</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">reject</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">state</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">value</span><span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-size: 9px;"><span style="font-family: Monaco;">);<br/>
    }</span></span></span></div>
<div><span style="font-size: 9px;"><span style="font-family: Monaco;">}); }</span></span></div>
<div>当一个rejection发生的时候，下一个catch会处理，而catch handler的返回值会被当成resolution而不是rejection，继续正常执行</div>
<div><br/></div>
<div>exception handling：explicitly rejecting是一回事，发生异常是另一回事，当一个promise callback抛出异常时应当在下一个rejection handler被处理。同样在processQueue中增加try...catch，有e存在则deferred.reject(e)，作为next promise的rejection。</div>
<div><br/></div>
<div>一个promise callback返回另外一个promise：应该将这个返回的promise连接到chain里面的下一个callback。一个Deferred可能会被另外一个promise进行resolve，这时这个deferred的resolution取决于另外一个promise的resolution。</div>
<div>当一个finally返回promise时，要等待这个promise被resolve才会继续。</div>
<div><br/></div>
<div>notifying progress：Deferred有一个notify方法，用来发送一些关于what kind of progress的信息。notify callback作为then的第三个参数，pending的数组里面也加上它。Deferred的notify方法遍历所有的pending handlers，然后调用progress callbacks。resolution之后notif则不应该再调用progress callback，通过status判断。</div>
<div>notifications是会被通过chains传播的。当一个progress callback抛出异常不影响其他callbacks。</div>
<div><br/></div>
<div>包装的API：$q.reject：immediate rejection，$q.when或者$q.resolve：immediate resolution</div>
<div>$q.all：关于promise的一个collection，用$q.all来合并和处理所有的异步操作，返回单个Promise对象来resolve一个results的数组。</div>
<div><br/></div>
<div>ES6-style Promises：没有明显的Deferred的概念，</div>
<div><span style="font: 9.0px Monaco; color: #017121">return new</span> <span style="font: 9.0px Monaco; color: #05297d">Promise</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">function</span><span style="font: 9.0px Monaco">(resolve, reject) {</span> <span style="font: 9.0px Monaco; color: #05297d">doAsyncStuff</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">function</span><span style="font: 9.0px Monaco">(err) {<br/></span><span style="font: 9.0px Monaco; color: #017121">if</span> <span style="font: 9.0px Monaco">(err) {</span> <span style="font: 9.0px Monaco; color: #05297d">reject</span><span style="font: 9.0px Monaco">(err);<br/>
}</span> <span style="font: 9.0px Monaco; color: #017121">else</span> <span style="font: 9.0px Monaco">{<br/></span><span style="font: 9.0px Monaco; color: #05297d">resolve</span><span style="font: 9.0px Monaco">(); }</span></div>
<div><span style="font-size: 9px;"><span style="font-family: Monaco;">}); });</span></span></div>
<div><br/></div>
<div>$$q：Promises without $digest integration，使用browser timeout，和digest没有关系。</div>
<div><br/></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">In this chapter you have learned:<br/>
• What kinds of problems Promises are designed to solve.<br/>
• About some of the existing Promise implementations for JavaScript.<br/>
• How AngularJS Promises compare to some of the other existing implementations.<br/>
• That Promises are made available in Angular by the</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">$q</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">and</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">$$q</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">services.</span></div>
<div><span style="font-family: Helvetica;">• That Promises are always paired with Deferreds, and whereas a Promise is accessed </span><span style="font-family: Helvetica;">by the consumer of an asynchronously produced value, a Deferred is accessed by its </span><span style="font-family: Helvetica;">producer.</span></div>
<div><span style="font-family: Helvetica;">• That when a Deferred is resolved, the associated Promise callbacks get invoked with<span style="font-family: Monaco;"> </span></span><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">$evalAsync</span><span style="font-family: Helvetica;">.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-family: Helvetica;">• That each Promise is resolved at most once.<br/>
• That each Promise callback is invoked at most once.</span></span></div>
<div><span style="font-family: Helvetica;">• How a Promise callback is invoked even when registered after the Promise was already </span><span style="font-family: Helvetica;">resolved.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-family: Helvetica;">• How Promises can be either resolved or rejected.<br/>
• That rejections can be caught by rejection errbacks.</span></span></div>
<div><span style="font-family: Helvetica;">• That you can execute resource cleanup code in finally callbacks, which are callbacks </span><span style="font-family: Helvetica;">that are invoked for both rejected and resolved Promises.</span></div>
<div><span style="font-family: Helvetica;">• How you can chain several</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">then</span><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">,</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">catch</span><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">, and</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">finally</span> <span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-family: Helvetica;">calls together, and each call </span></span><span style="font-family: Helvetica;">creates a new Promise chained to the previous one.</span></div>
<div><span style="font-family: Helvetica;">• How even the last (or only)</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">then</span> <span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-family: Helvetica;">in your Promise chain creates another Promise, but </span></span><span style="font-family: Helvetica;">that it is simply ignored.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-family: Helvetica;">• How an exception thrown in a Promise handler rejects the next Promise in the chain.<br/>
• How an exception caught by a rejection errback resolves the next Promise in the<br/>
chain.<br/>
• That a Promise callback may return another Promise, and how that Promise’s<br/>
eventual resolution or rejection is linked to the Promise chain.</span></span></div>
<div><span style="font-family: Helvetica;">• That finally handlers can also return Promises and they are resolved before continuing </span><span style="font-family: Helvetica;">with the chain, but that the values they resolve to are ignored.</span></div>
<div><span style="font-family: Helvetica;">• How Deferreds can notify about progress, and how progress callbacks are registered.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">• That, unlike all other Promise callbacks, notification callbacks may get called several times.<br/>
• How notification messages can be transformed in a Promise chain.<br/>
• How an immediately rejected Promise can be created with</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">$q.reject</span><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">.<br/>
• How an immediately resolved Promise can be created with</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">$q.when</span><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">.<br/>
• How</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">$q.when</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">can also be used to adopt a foreign Promise.</span></div>
<div><span style="font-family: Helvetica;">• How an array or object of Promises can be resolved to an array or object of values </span><span style="font-family: Helvetica;">with</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">$q.all</span><span style="font-family: Helvetica;">.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">• That</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">$q.all</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">is rejected if even one of its argument Promises is rejected.<br/>
• That not all of the items in the collection given to</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">$q.all</span> <span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-family: Helvetica;">have to be Promises.</span></span></div>
<div><span style="font-family: Helvetica;">• How</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">$q</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">also supports an alternative ES6-style Promise API.</span></div>
<div><br/></div>
<div>Chapter 14: $http</div>
<div>$http service，处理Angular applications的HTTP通信。$http对象的基础是通过浏览器的XMLHttpRequest support进行HTTP请求，包装了error management，interceptor等等功能。</div>
<div>（这一章除了主要功能之外，除了主要收发请求的实现之外小功能很多比较乱，就和summary放一起总结了，可能跳过一些琐碎的内容）</div>
<div><br/></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">• That HTTP requests in Angular are handled by two collaborating services:</span><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$http </span><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">and</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$httpBackend</span><span style="font-family: Helvetica;">. The backend may be overriden to provide an alternative transport or to mock it out during testing.</span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-family: Helvetica;">测试的时候使用SinonJS库来检测发出的请求，和假装做response。</span></div>
<div><span style="font-family: Helvetica;">HTTP请求是异步的，因此$http不能直接返回response，而是返回一个Promise。$httpBackend来做实际的发送标准XMLHttpRequest，不处理任何的Deferred或者Promises，而是接受一个callback function，作为</span><font face="Helvetica">xhr.onload。xhr.onload会试图从hr.response或xhr.responseText接收response body。$http中构造这个callback函数传给$httpBackend。</font></div>
<div><br/></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">• That</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$http</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">kicks o  a digest on the</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$rootScope</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">when the response arrives - unless</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">useApplyAsync</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">is enabled, in which case it uses</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$rootScope.$applyAsync</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">to do it later.</span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><font face="Helvetica">使用Angular的人不用考虑何时调用$apply，框架会处理。如果有错误发生，可以直接reject the Promise而不是resolve。包括400之类的response code，或者网络故障，CORS等。</font></div>
<div><span style="font-family: Helvetica;">response code 在200以上300以下是success。</span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-family: Helvetica;">• That</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$http.defaults</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">(and</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$httpProvider.defaults</span><span style="font-family: Helvetica;">) allows setting some default configurations that’ll be used for all requests.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">• How you can supply HTTP headers by providing a</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">headers</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">object in the request configuration.<br/>
• How Angular has some default headers, such as</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">Accept</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">and</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">Content-Type</span><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">, but that you can override them using</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$http.defaults</span><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal;"><span style="font-family: Helvetica;">.<br/>
• That default and request-specific headers are merged case-insensitively, since that’s how headers work according to the HTTP standard.</span></span></div>
<div><span style="font-family: Helvetica;">• That request header values may also be functions that return the concrete header values when called.</span></div>
<div><span style="font-family: Helvetica;">request headers：headers可以默认设置，也有request specific，使用_.extend方法将这些headers拼在一起。不是所有HTTP方法的default headers长一样，例如POST应该有一个默认的Content-Type header设置为JSON，GET没有content type。HTTP headers 对key的大小写不敏感。</span></div>
<div><span style="font-family: Helvetica;">header也可能是一个返回string的函数。</span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">• That response headers are available through the</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">headers</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">function attached to the response object, and how that function treats header names case-insensitively.</span></div>
<div><span style="font-family: Helvetica;">• That response headers are parsed lazily only when requested.</span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><font face="Helvetica">response headers首先在$httpBackend获得，xhr.getAllResponseHeaders()，headersGetter函数输入headers string，返回解析了的header names to header values。这个解析是lazy的，到第一个header被request才开始解析。实际的解析工作在parseHeaders函数内完成，根据每一行的:符号进行解析。</font></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">• How CORS authorization can be enabled by supplying the</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">withCredentials</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">flag in </span><span style="font-family: Helvetica;">request objects.</span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-family: Helvetica;">CORS默认下跨站请求不包括任何的cookies或者authentication headers，如果需要则需要在XMLHttpRequest设置withCredentials flag。</span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">• That both request and response bodies can be transformed using transforms that</span></div>
<div><span style="font-family: Helvetica;">are registered with the</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">transformRequest</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">and</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">transformResponse</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">attributes, which </span><span style="font-family: Helvetica;">may be either supplied in</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$http.defaults</span> <span style="font-family: Helvetica;">or individual request objects</span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">• That Angular uses request and response transforms to do JSON serialization and<br/>
parsing by default.<br/>
• How request data is serialized to JSON when it is an array or an object, unless it is<br/>
a special object like a Blob, File, or FormData.<br/>
• How response data is parsed as JSON when it’s either specified as such with a</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">Content-Type</span> <span style="font-family: Helvetica;">header, or when it merely looks like JSON.</span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-family: Helvetica;">JSON like：正则表达式判断，</span></div>
<div><span style="font: 9.0px Monaco; color: #017121">function</span> <span style="font: 9.0px Monaco; color: #05297d">isJsonLike</span><span style="font: 9.0px Monaco">(data) {<br/></span><span style="font: 9.0px Monaco; color: #017121">if</span> <span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">data</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">match</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">/</span><span style="font: 9.0px Monaco; color: #40a070">^\{(?</span><span style="font: 9.0px Monaco; color: #017121">!</span><span style="font: 9.0px Monaco; color: #40a070">\{)</span><span style="font: 9.0px Monaco; color: #017121">/</span><span style="font: 9.0px Monaco">)) {<br/></span><span style="font: 9.0px Monaco; color: #017121">return data</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">match</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">/</span><span style="font: 9.0px Monaco; color: #40a070">\}$</span><span style="font: 9.0px Monaco; color: #017121">/</span><span style="font: 9.0px Monaco">);<br/>
}</span> <span style="font: 9.0px Monaco; color: #017121">else if</span> <span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">data</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">match</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">/</span><span style="font: 9.0px Monaco; color: #40a070">^\[</span><span style="font: 9.0px Monaco; color: #017121">/</span><span style="font: 9.0px Monaco">)) {<br/></span><span style="font: 9.0px Monaco; color: #017121">return data</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">match</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">/</span><span style="font: 9.0px Monaco; color: #40a070">\]$</span><span style="font: 9.0px Monaco; color: #017121">/</span><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal;"><span style="font-size: 9px;"><span style="font-family: Monaco;">); }</span></span></span></div>
<div><span style="font-size: 9px;"><span style="font-family: Monaco;">}</span></span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">• How single- and multi-value URL parameters can be supplied, and how they are<br/>
escaped and attached to the request URL.</span></div>
<div><span style="font-family: Helvetica;">• That objects are serialized into JSON when used as URL parameters.</span></div>
<div><span style="font-family: Helvetica;">buildUrl方法</span>构造url，例如 <span style="font: 9.0px Monaco; color: #4071a0"> http://teropa.info?a=42&amp;b=42 </span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">• That Dates are serialized into their ISO 8601 representation when used as URL</span></div>
<div><span style="font-family: Helvetica;">parameters.</span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-family: Helvetica;">编码方法：Javascript自带的encodeURIComponent</span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">• That three short-hand methods are provided for HTTP methods without bodies:<br/></span><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$http.get</span><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">,</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$http.head</span><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">, and</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$http.delete</span><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">.</span></div>
<div><span style="font-family: Helvetica;">• That three short-hand methods are provided for HTTP methods that do have bodies:</span><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">$http.post</span><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">,</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$http.put</span><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">, and</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$http.patch</span><span style="font-family: Helvetica;">.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">• How interceptor factories can be registered directly to the</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$httpProvider</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">or as<br/>
references to existing factories.<br/>
• That interceptors are objects with one or more of the following methods:</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">request</span><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">,<br/></span><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">requestError</span><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">,</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">response</span><span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">, and</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">responseErrors</span><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">.<br/>
• How interceptors form a Promise-based pipeline for processing the HTTP request</span></div>
<div><span style="font-family: Helvetica;">and response.</span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-family: Helvetica;">interceptors：另外一个可以处理HTTP requests and responses的功能，比transform功能更多。interceptors可以随意修改和替换</span><span style="font-family: Helvetica;">requests and responses。interceptors基于promise实现，因此可以做一些异步的工作。</span></div>
<div><span style="font-family: Helvetica;">interceptors是包括了request, requestError, response, responseError 的对象，这些key对应的value是HTTP request不同阶段的函数。例如</span></div>
<div><span style="font: 9.0px Monaco; color: #05297d">it</span><span style="font: 9.0px Monaco">(</span> <span style="font: 9.0px Monaco; color: #4071a0">allows intercepting requests</span> <span style="font: 9.0px Monaco">,</span> <span style="font: 9.0px Monaco; color: #017121">function</span><span style="font: 9.0px Monaco">() {<br/></span><span style="font: 9.0px Monaco; color: #017121">var</span> <span style="font: 9.0px Monaco">injector =</span> <span style="font: 9.0px Monaco; color: #05297d">createInjector</span><span style="font: 9.0px Monaco">([</span> <span style="font: 9.0px Monaco; color: #4071a0">ng</span> <span style="font: 9.0px Monaco">,</span> <span style="font: 9.0px Monaco; color: #017121">function</span><span style="font: 9.0px Monaco">($httpProvider) {<br/></span><span style="font: 9.0px Monaco; color: #017121">$httpProvider</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #017121">interceptors</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">push</span><span style="font: 9.0px Monaco">(</span><span style="font: 9.0px Monaco; color: #017121">function</span><span style="font: 9.0px Monaco">() {</span> <span style="font: 9.0px Monaco; color: #017121">return</span> <span style="font: 9.0px Monaco">{<br/></span><span style="font: 9.0px Monaco; color: #8f2100">request</span><span style="font: 9.0px Monaco">:</span> <span style="font: 9.0px Monaco; color: #017121">function</span><span style="font: 9.0px Monaco">(config) {</span> <span style="font: 9.0px Monaco; color: #017121">config</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #017121">params</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">intercepted</span> <span style="font: 9.0px Monaco">=</span> <span style="font: 9.0px Monaco; color: #017121">true</span><span style="font: 9.0px Monaco">;<br/></span><span style="font: 9.0px Monaco; color: #017121">return</span> <span style="font: 9.0px Monaco">config; }<br/>
}; });<br/>
  }]);<br/>
  $http =</span> <span style="font: 9.0px Monaco; color: #017121">injector</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">get</span><span style="font: 9.0px Monaco">(</span> <span style="font: 9.0px Monaco; color: #4071a0">$http</span> <span style="font: 9.0px Monaco">);<br/>
  $rootScope =</span> <span style="font: 9.0px Monaco; color: #017121">injector</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">get</span><span style="font: 9.0px Monaco">(</span> <span style="font: 9.0px Monaco; color: #4071a0">$rootScope</span> <span style="font: 9.0px Monaco">);<br/></span><span style="font: 9.0px Monaco; color: #017121">  $http</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">get</span><span style="font: 9.0px Monaco">(</span> <span style="font: 9.0px Monaco; color: #4071a0"><a href="http://teropa.info">http://teropa.info</a></span> <span style="font: 9.0px Monaco">, {</span><span style="font: 9.0px Monaco; color: #8f2100">params</span><span style="font: 9.0px Monaco">: {}});<br/></span><span style="font: 9.0px Monaco; color: #017121">  $rootScope</span><span style="font: 9.0px Monaco">.</span><span style="font: 9.0px Monaco; color: #05297d">$apply</span><span style="font: 9.0px Monaco">();<br/></span><span style="font: 9.0px Monaco; color: #05297d">  expect</span><span style="font: 9.0px Monaco">(requests[</span><span style="font: 9.0px Monaco; color: #40a070">0</span><span style="font: 9.0px Monaco">].</span><span style="font: 9.0px Monaco; color: #05297d">url</span><span style="font: 9.0px Monaco">).</span><span style="font: 9.0px Monaco; color: #05297d">toBe</span><span style="font: 9.0px Monaco">(</span> <span style="font: 9.0px Monaco; color: #4071a0">http://teropa.info?intercepted=true</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal;"><span style="font-size: 9px;"><span style="font-family: Monaco;">);</span></span></span></div>
<div><span style="font-size: 9px;"><span style="font-family: Monaco;">});</span></span></div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%204%3A%20Utilities.resources/AA9DDE05-BCE1-42D0-914D-4BE3851A827C.png" height="1072" width="1202"/></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-family: Helvetica;">• That response interceptors are invoked in reverse order compared to how they were </span><span style="font-family: Helvetica;">registered.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">• How</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$http</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">extends Promise with two methods useful for dealing with HTTP re-<br/>
sponses:</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">success</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">and</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">error</span><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">.</span></div>
<div><span style="font-family: Helvetica;">• How a request can be aborted with a Promise-based or a numeric timeout attribute.</span></div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div>timeout：应对一些太长时间返回或者没有返回的情况，可以在request configuration object上设置timeout属性，然后设置一些这个值的promise，如果到了时间Angular会中止请求，resolve这个timeout。</div>
<div><span style="font-family: Helvetica;"><br/></span></div>
<div><span style="font-family: Helvetica;">• How</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$http</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">can use the</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$applyAsync</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">feature of Scope to skip unnecessary digests </span><span style="font-family: Helvetica;">when several HTTP responses arrive in quick succession.</span></div>
<div><span style="font-family: Helvetica;">• That the</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Monaco;">$applyAsync</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">optimization is not enabled by default, and you have to call<span style="font-family: Monaco;"> </span></span><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">$httpProvider.useApplyAsync(true)</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; line-height: normal; font-family: Helvetica;">to enable it.</span></div>
<div><br/></div>
<div>关于$applyAsync和$http，原本的motivation是，在应用启动时通常会发起多个请求，如果服务器很快response也会很快，这是Angular会对每个response开始一个新的digest。优化是如果几个请求很接近，他们触发的变化在一个digest内完成，这样可以减少时间消耗。这不是默认的优化，需要添加参数开启。</div>
<div><br/></div>
<div><br/></div>
<div><br/></div>
<div><br/></div>
<div><br/></div>
<div><br/></div>
</body></html>