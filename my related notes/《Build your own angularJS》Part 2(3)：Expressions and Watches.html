<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.0.16 (451861)"/><meta name="altitude" content="14"/><meta name="author" content="markselby"/><meta name="created" content="2015-12-13 04:03:20 +0000"/><meta name="latitude" content="31.29922287268856"/><meta name="longitude" content="121.498780793007"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2015-12-15 07:17:57 +0000"/><title>《Build your own angularJS》Part 2(3)：Expressions and Watches</title></head><body>
<div>Chapter 9: Expressions And Watches</div>
<div>将Expressions和Scopes结合起来，包括$watch, $watchCollection，$eval（相关的$apply和$evalAsync）</div>
<div>watchFn = parse(watchFn)，之后会变成$parse service</div>
<div><br/></div>
<div>Literal and constant expressions：</div>
<div>returned function除了plain function之外还有一些其他属性，如布尔属性 literal，constant，assign。Literal flag的实现用一个新的函数isLiteral，</div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">function</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">isLiteral</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(ast) {</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">return</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">ast</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">body</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">length</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">===</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 63.000000%, 44.000000%)">0</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">||</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">    ast</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">body</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">length </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">=== </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 63.000000%, 44.000000%)">1 </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">&amp;&amp; (</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">      ast</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">body</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">[</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 63.000000%, 44.000000%)">0</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">].</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">type </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">=== </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">AST</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">Literal </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">||<br/></span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">      ast</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">body</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">[</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 63.000000%, 44.000000%)">0</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">].</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">type </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">=== </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">AST</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">ArrayExpression </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">||</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">      ast</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">body</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">[</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 63.000000%, 44.000000%)">0</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">].</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">type </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">=== </span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">AST</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">ObjectExpression</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">);</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMono9'">}</span></div>
<div>constant flag需要分别考虑每个AST node type来决定如何判断”constantness”，同样用switch ast.type分别考虑。</div>
<div><br/></div>
<div>对Constant expression watching的优化：constant expression总会返回相同的值，所以对应的watch会在第一次被trigger，之后不会再变成dirty了，也就是说这个watch可以被移除了。</div>
<div>实现：$$watchDelegate，</div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">if</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">(</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">watchFn</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">$$watchDelegate</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">) {</span></div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">return</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">watchFn</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">.</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(2.000000%, 16.000000%, 49.000000%)">$$watchDelegate</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'">(self, listenerFn, valueEq, watchFn); }</span></div>
<div>$$表示这是Angular的内部facility，不是用来直接使用的。</div>
<div>parse.js中实现$$watchDelegate，</div>
<div>
<div style="background-color:#ffffff;color:#000000;font-family:'Menlo';font-size:12.0pt;"><span style="color:#808080;font-style:italic;">//chapter 9<br/></span><span style="color:#808080;font-style:italic;">// a watcher that behaves like any other watcher, except that it removes itself immediately upon first invocation<br/></span><span style="color:#000080;font-weight:bold;">function </span><span style="font-style:italic;">constantWatchDelegate</span>(scope, listenerFn, valueEq, watchFn){<br/>
    <span style="color:#000080;font-weight:bold;">var </span><span style="color:#458383;">unwatch </span>= scope.<span style="color:#7a7a43;">$watch</span>(<br/>
        <span style="color:#000080;font-weight:bold;">function</span>(){ <span style="color:#808080;font-style:italic;">//wrap in a function with no $$watchDelegate<br/></span><span style="color:#808080;font-style:italic;">           </span> <span style="color:#000080;font-weight:bold;">return </span>watchFn(scope);<br/>
        },<br/>
        <span style="color:#000080;font-weight:bold;">function</span>(newValue, oldValue, scope){<br/>
            <span style="color:#000080;font-weight:bold;">if </span>(<span style="color:#660e7a;font-weight:bold;font-style:italic;">_</span>.<span style="color:#660e7a;font-weight:bold;">isFunction</span>(listenerFn)){<br/>
                listenerFn.<span style="color:#7a7a43;">apply</span>(<span style="color:#000080;font-weight:bold;">this</span>, <span style="color:#458383;">arguments</span>);<br/>
            }<br/>
            <span style="color:#458383;">unwatch</span>();<br/>
        },<br/>
        valueEq<br/>
    );<br/>
    <span style="color:#000080;font-weight:bold;">return </span><span style="color:#458383;">unwatch</span>;<br/>
}<br/></div>
</div>
<div><br/></div>
<div>One Time expressions：</div>
<div>当watcher的value在这个watcher存在的时候不会改变时，可以用one time expressions，前面加两个引号，如</div>
<div><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">&lt;li</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(0.000000%, 44.000000%, 13.000000%)">ng-repeat=</span><span style="font-size: 9.000000pt; font-family: 'LMMono9'; color: rgb(25.000000%, 44.000000%, 63.000000%)">"user in users"</span><span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">&gt;</span> <span style="font-size: 9.000000pt; font-family: 'LMMono9'">{{user.firstName}} {{user.lastName}}</span> <span style="font-size: 9.000000pt; font-family: 'LMMonoLt10'; font-weight: 700; color: rgb(0.000000%, 44.000000%, 13.000000%)">&lt;/li&gt;</span></div>
<div>对于一个特定user的first name和last name是只读的，不会去修改他，然而Angular还需要在每次digest都去进行dirty check，这可以优化，Angular的优化feature是one-time binding。</div>
<div>one-time watcher和普通watcher的区别是当one-time watcher被使用了之后会自动移除，不存在于之后的digest loop。这个watch被移除的时候是要求这个对象不是undefined的。</div>
<div>如果one time expression是literal的，处理方式稍微有些不同，这里假设expression value是一个collection，然后检查是否包括的所有Items都是defined。</div>
<div><br/></div>
<div>Input tracking：</div>
<div>当一个expression是又多个input expressions组成的，比如a*b由a和b组成，除非组成的input expression变化了，否则就不需要重新检查。实现方法是扩展AST compiler，使得它不仅包括full expression function，也包括一个input expression functions的集合。input tracking是通过维护一个input expressions的数组实现的。每次watch run都是遍历一遍所有inputs看有没有changed。实现markConstantAndWatchExpression方法，在AST内递归调用，使得每个node都有一个toWatch array。</div>
<div>input checking的过程：</div>
<div>1，compiler遍历每个AST节点，根据它的input nodes设置toWatch属性</div>
<div>2，对于每个top-level expression的input生成一个独立的Javascript function body，inputs取决于之前的toWatch属性。</div>
<div>3，compiler的watchFns生成上一步的每个function body的input expression function，与main expression function的inputs属性绑定。</div>
<div>4，当一个expression被watch时，绑定一个inputs watch delegate</div>
<div>5，inputs watch delegate会watch它在inputs找到的每个函数，而不是去watch main expression function</div>
<div><br/></div>
<div>Stageful Filters：</div>
<div>filters一般是pure functions，也就是说filter 通常会对于同样的输入给出同样的输出。然而有时候可能有例外，比如和时间有关的filter，Angular允许对于这种filter设置一个$stateful属性，如果设置为true则不会进行input tracking。</div>
<div><br/></div>
<div>External Assignment：</div>
<div>可能在scope进行外部的assign，这时compiler要生成新的expression function，与main expression function的assign方法进行绑定。assignable AST当且仅当expression只有一个assignment, type是identifier或者member的时候行成。AST.AssignmentExpression左侧是ast.body[0]，右侧是{type:AST.NGValueParameter}</div>
<div><br/></div>
<div>总结：</div>
<div>本章把Scope和Expression结合起来，并且加入了几个新的特性，对性能优化很重要。</div>
<ol>
<li>Scope如何使用parser对expression进行处理</li>
<li>expression如何被标注为constant或者literal</li>
<li>watch delegate取代一般的watch，如何对性能进行优化</li>
<li>constant watch delegate, one-time binding, input tracking, stageful filters</li>
</ol>
<div><br/></div>
<div><br/></div>
<div><br/></div>
<div><br/></div>
<div><br/></div>
<div><br/></div>
<div><br/></div>
</body></html>