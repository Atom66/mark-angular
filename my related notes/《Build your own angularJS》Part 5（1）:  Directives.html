<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 6.0.16 (451861)"/><meta name="altitude" content="71.09609985351562"/><meta name="author" content="markselby"/><meta name="created" content="2016-02-01 13:43:00 +0000"/><meta name="latitude" content="28.14929972497698"/><meta name="longitude" content="112.9836766876833"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2016-02-19 13:00:22 +0000"/><title>《Build your own angularJS》Part 5（1）:  Directives</title></head><body>
<div>Chapter 15：DOM Compilation and Basic Directives</div>
<div>directive compiler：将自定义的行为通过特殊元素、属性、类、注释来附着在DOM元素上。</div>
<div>compilation：将directives应用到DOM上的过程。输入DOM结构，输出转变之后的DOM结构。几乎任何转变都可能</div>
<div><br clear="none"/></div>
<div>注册$compile Provider：</div>
<div><span style="font: 9.0px Monaco; color: #017121;">  ngModule</span><span style="font: 9.0px Monaco;">.</span><span style="font: 9.0px Monaco; color: #05297d;">provider</span><span style="font: 9.0px Monaco;">(</span> <span style="font: 9.0px Monaco; color: #4071a0;">$compile</span> <span style="font: 9.0px Monaco;">,</span> <span style="font: 9.0px Monaco; color: #05297d;">require</span><span style="font: 9.0px Monaco;">(</span> <span style="font: 9.0px Monaco; color: #4071a0;">./compile</span> <span style="font: 9.0px Monaco;">));</span></div>
<div>注册Directives：</div>
<div>directive的注册和filters，service, factory类似，通过模块的directive方法。在loader.js的moduleInstance中增加directive方法</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/3834BED6-8CCF-403F-AA61-ED47CDBD4C4F.png" height="760" width="1208"/></div>
<div><br clear="none"/></div>
<div>注册一个directive的时候实际上相当于给injector（provider）一个factory，但是一个directive name可以注册多个directive（维护为每个name对应一个数组）。注册时会自动在名字后面加上Directive后缀。</div>
<div><br clear="none"/></div>
<div>directive definition object：键值对对应这个directive的行为。一个key是compile，定义compilation function。应用到DOM上是通过给DOM加一个和directive name相同名字的element。</div>
<div>单元测试的内容：</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/FC2F8717-91E1-4A3A-A708-DDFC7F2DEE61.png" height="624" width="1188"/></div>
<div>1，注册一个myDirective到一个injector里面</div>
<div>2，使用jQuery来解析一个DOM段，element name是my-element</div>
<div>3，调用injector的$compile方法来编译</div>
<div><br clear="none"/></div>
<div>编译过程：compileNodes遍历整个jQuery object，分别处理每个node。collectDirectives输入一个DOM node，通过addDirective找到应该应用的directives，然后作为一个数组返回。回到compileNodes，通过applyDirectivesToNode方法将directives应用到node上，通过调用每个directive的compile方法。</div>
<div>Angular将directive和DOM搭配的方法包括四种，element name, attribute name, class name, special comments</div>
<div><br clear="none"/></div>
<div>recursing to child elements：通过node.childNodes访问到子节点，递归调用</div>
<div>前缀：Angular允许的DOM名字的前缀有x和data，也可以使用_,-,:符号</div>
<div><br clear="none"/></div>
<div>restricting directive application：给directive definition object增加一个restrict属性，来限制这个directive可用于搭配哪几种matching modes。</div>
<div><span style="font: 9.0px Helvetica;">•</span> <span style="font: 9.0px Monaco;">E</span> <span style="font: 9.0px Helvetica;">means “match with element names”</span></div>
<div><span style="font: 9.0px Helvetica;">•</span> <span style="font: 9.0px Monaco;">A</span> <span style="font: 9.0px Helvetica;">means “match with attribute names”</span></div>
<div><span style="font: 9.0px Helvetica;">•</span> <span style="font: 9.0px Monaco;">C</span> <span style="font: 9.0px Helvetica;">means “match with class names”<br clear="none"/>
•</span> <span style="font: 9.0px Monaco;">M</span> <span style="font: 9.0px Helvetica;">means “match with comments”<br clear="none"/>
•</span> <span style="font: 9.0px Monaco;">EA</span> <span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-size: 9px;"><span style="font-family: Helvetica;">means “match with element names and attribute names”</span></span></span></div>
<div><span style="font-size: 9px;"><span style="font-family: Helvetica;">•</span> <span style="font: 9.0px Monaco;">MCA</span> <span style="font: 9.0px Helvetica;">means “match with comments, class names, and attribute names” • etc.</span></span></div>
<div><br clear="none"/></div>
<div>Prioritizing directives：directive definition object增加priority属性，priority越大优先级越大。priority相同比较名字，名字相同比较注册的先后顺序。</div>
<div><br clear="none"/></div>
<div>terminating compilation：terminal directive用于中止编译，例如ng-if的情况。增加terminal:true属性</div>
<div><br clear="none"/></div>
<div>Applying directives across multiple nodes：</div>
<div><span style="font: 9.0px Monaco; color: #05297d;">it</span><span style="font: 9.0px Monaco;">(</span> <span style="font: 9.0px Monaco; color: #4071a0;">allows applying a directive to multiple elements</span> <span style="font: 9.0px Monaco;">,</span> <span style="font: 9.0px Monaco; color: #017121;">function</span><span style="font: 9.0px Monaco;">() {</span> <span style="font: 9.0px Monaco; color: #017121;">var</span> <span style="font: 9.0px Monaco;">compileEl =</span> <span style="font: 9.0px Monaco; color: #017121;">false</span><span style="font: 9.0px Monaco;">;<br clear="none"/></span><span style="font: 9.0px Monaco; color: #017121;">var</span> <span style="font: 9.0px Monaco;">injector =</span> <span style="font: 9.0px Monaco; color: #05297d;">makeInjectorWithDirectives</span><span style="font: 9.0px Monaco;">(</span> <span style="font: 9.0px Monaco; color: #4071a0;">myDir</span> <span style="font: 9.0px Monaco;">,</span> <span style="font: 9.0px Monaco; color: #017121;">function</span><span style="font: 9.0px Monaco;">() {<br clear="none"/></span><span style="font: 9.0px Monaco; color: #017121;">return</span> <span style="font: 9.0px Monaco;">{<br clear="none"/></span><span style="font: 9.0px Monaco; color: #8f2100;">multiElement</span><span style="font: 9.0px Monaco;">:</span> <span style="font: 9.0px Monaco; color: #017121;">true</span><span style="font: 9.0px Monaco;">,</span> <span style="font: 9.0px Monaco; color: #8f2100;">compile</span><span style="font: 9.0px Monaco;">:</span> <span style="font: 9.0px Monaco; color: #017121;">function</span><span style="font: 9.0px Monaco;">(element) {<br clear="none"/>
        compileEl = element;<br clear="none"/>
      }<br clear="none"/>
}; });<br clear="none"/></span><span style="font: 9.0px Monaco; color: #017121;">injector</span><span style="font: 9.0px Monaco;">.</span><span style="font: 9.0px Monaco; color: #05297d;">invoke</span><span style="font: 9.0px Monaco;">(</span><span style="font: 9.0px Monaco; color: #017121;">function</span><span style="font: 9.0px Monaco;">($compile) {<br clear="none"/></span><span style="font: 9.0px Monaco; color: #017121;">var</span> <span style="font: 9.0px Monaco;">el =</span> <span style="font: 9.0px Monaco; color: #05297d;">$</span><span style="font: 9.0px Monaco;">(</span> <span style="font: 9.0px Monaco; color: #4071a0;">&lt;div my-dir-start&gt;&lt;/div&gt;&lt;span&gt;&lt;/span&gt;&lt;div my-dir-end&gt;&lt;/div&gt;</span> <span style="font: 9.0px Monaco;">);</span> <span style="font: 9.0px Monaco; color: #05297d;">$compile</span><span style="font: 9.0px Monaco;">(el);<br clear="none"/></span><span style="font: 9.0px Monaco; color: #05297d;">expect</span><span style="font: 9.0px Monaco;">(</span><span style="font: 9.0px Monaco; color: #017121;">compileEl</span><span style="font: 9.0px Monaco;">.</span><span style="font: 9.0px Monaco; color: #05297d;">length</span><span style="font: 9.0px Monaco;">).</span><span style="font: 9.0px Monaco; color: #05297d;">toBe</span><span style="font: 9.0px Monaco;">(</span><span style="font: 9.0px Monaco; color: #40a070;">3</span><span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-size: 9px;"><span style="font-family: Monaco;">);</span></span></span></div>
<div><span style="font-size: 9px;"><span style="font-family: Monaco;">}); });</span></span></div>
<div>directive需要设置multiElement:true的属性，并且只能应用于attribute matching。compile函数应用的对象是start element和end element中间的所有object</div>
<div>1，发现-start后缀时，处理名字去掉后缀，2，寻找有没有对应的multi-element directive</div>
<div>实现时在处理了name之后，对对应的directive object增加$$start和$$end，</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/CA19CDAE-7196-4B6B-8467-62B8D1388646.png" height="682" width="1244"/></div>
<div>applyDirectivesToNode时，当发现了$$start属性，则调用groupScan方法寻找作用的nodes。</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/2F50761D-E366-4F96-BEA9-B769AF1F0E3D.png" height="868" width="1236"/></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">In this chapter you have learned:</span></div>
<div><span style="font-family: Helvetica;">• How the</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">$compile</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">provider is constructed</span></div>
<div><span style="font-family: Helvetica;">• That directive registration happens outside of the core dependency injection mecha</span><span style="font-family: Helvetica;">nisms but integrates with it.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">• That directives are available from the injector though they’re usually applied via</span><span style="font-family: Helvetica;"> DOM compilation.</span></div>
<div><span style="font-family: Helvetica;">• That an Angular application may have several directives with the same name.</span></div>
<div><span style="font-family: Helvetica;">• How several directives can be registered with one </span><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">module.directive()</span> <span style="font-family: Helvetica;">invocation </span><span style="font-family: Helvetica;">using the shorthand object notation.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">• How the DOM compilation happens: For each node in the compiled DOM, matching </span><span style="font-family: Helvetica;">directives are collected and then applied to the node.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">• How the compiler recurses into child nodes after their parents are compiled.<br clear="none"/>
• How the directive name can be prefixed in di erent ways when specified in the DOM.<br clear="none"/>
• How the di erent matching modes (element, attribute, class, comment) work.</span></div>
<div><span style="font-family: Helvetica;">• How directives can be restricted to only match certain modes, where the default is<span style="font-family: Monaco;"> </span></span><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">’A’</span> <span style="font-family: Helvetica;">for attribute matching.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">• How directives can be applied over a group of sibling nodes by having</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">-start</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">and<span style="font-family: Monaco;"> </span></span><span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Monaco;">-end</span> <span style="font-style: normal; font-variant: normal; font-weight: normal; font-family: Helvetica;">attributes in separate elements.</span></div>
<div><br clear="none"/></div>
<div><br clear="none"/></div>
<div><br clear="none"/></div>
<div>Chapter 16: Directive Attributes</div>
<div>element directive和class directive通常需要能够接触到属性，Attributes可以被用来配置Directives，向directives传递信息，并且attributes也可以提供directive to directive的通讯，通过observing的机制。</div>
<div>首先给compile函数增加第二个参数 attrs。对于每个编译的node需要构造一个attributes对象，并且在collectDirectives函数里收集这些attributes放入对象中。</div>
<div>单元测试的一般过程：1，注册一个directive，2，编译一个DOM段，3，拿到attributes object，4，对这个attributes object运行一些测试。</div>
<div><br clear="none"/></div>
<div>Boolean attributes: 例如disabled，Boolean attributes的特点在于他们一般没有一个显式的值，而是他们的存在意味着"true"，并且只应用与standard HTML里面定义的属性 。</div>
<div>ng-attr-前缀的属性会覆盖没有这个前缀的同名属性。正则表达式：<b>var</b> isNgAttr = /^ngAttr[A-Z]/.test(normalizedAttrName);</div>
<div><br clear="none"/></div>
<div>$set方法：attribute object现在包括了normalized attributes，我们给它除了读还加上写属性的方法$set。给Attributes构造函数加上Attributes(element)参数，Attributes.prototype.$set里面将key,value设置在自己上，this[key]=value，同时如果要将参数写到DOM元素上，还要调用element的DOM上attr方法，this.$$element.attr(key,value)。$set方法增加一个参数决定是否将set的内容写到DOM元素上。</div>
<div><br clear="none"/></div>
<div>Observing attributes：Attributes对象提供了一种directives中间针对单个元素的交流的方法。如果一个directive对一个attribute做了改变，要通知另一个directive这个改变事件，这个机制可以通过$watch完成，但是更好的是$observe机制。原因包括节约CPU cycle，</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/6762BC1C-297C-4A2F-9BC2-570072739631.png" height="456" width="764"/></div>
<div>实现方法是维护一个observers的表，key是attribute name，value是针对这个attribute的observer functions的数组。</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/7B775D74-9C15-40E2-9E65-508360D74BE9.png" height="254" width="596"/></div>
<div>这里用Object.create(null)而不是直接用null的原因是为了防止一些Object prototype潜在的属性名如toString, constructor等。虽然observers通常和digest没有关系，在初次调用里面仍然用到了Scope.$evalAsync，为了方便地异步调用。</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/FFC743EB-2749-4C0E-8327-EE5ABFADBFB4.png" height="203" width="552"/></div>
<div>在每个循环体里面，注意用try...catch...，当一个function出错的时候不影响其他这个observers里面的函数执行。</div>
<div><br/></div>
<div>providing class directives as attributes：class name同样放在attributes里面，设为undefined。因为class name可能形如：</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/ECC917CE-7B21-49E9-AA7F-613B29F87F0B.png" height="261" width="740"/></div>
<div>所以需要用到正则表达式来拿出class name。正则表达式是：<span style="font-family: LMMono9-Regular;">/([\d\w\-_]+)(?:\:([^;]+))?;?/</span></div>
<div><span style="font-family: LMMono9-Regular;">([\d\w\-_]+)</span>对应class name，(?...)?代表可选，其他两个括号是capturing group（通过比对正则表达式拿出来的结果）。</div>
<div><br/></div>
<div>manipulating classes：Attributes对象同样提供了一些操纵元素的CSS classes的方法，比如增加、删除、更新。实现方法直接使用this.$$element.addClass, removeClass，方法，update则是使用_.difference比较两个数组，然后删掉旧的classes加上新的。</div>
<div><br/></div>
<div><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">In this chapter you have learned:</span></div>
<div><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">• How an element’s attribute values are made available to directives using the </span><span style="font-family: LMMono9-Regular;">Attributes</span> <span style="font-family: LMRoman9-Regular;">object</span></div>
<div><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">• That boolean attribute values are always <span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">true <span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">when present, but only for the standard </span></span></span></span></span></span></span><span style="font-family: LMRoman9-Regular;">HTML boolean attributes.</span></div>
<div><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">• That the same <span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">Attributes <span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">object is shared by all the directives of an element.</span></span></span></span></span></span></span></span></span></span></span></div>
<div><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">• How attributes can be <span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">$set<span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">, and how the caller can decide whether to also change </span></span></span><span style="font-family: LMRoman9-Regular;">the DOM or only the corresponding JavaScript property.</span></div>
<div><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">• What the attribute name denormalization rules are when <span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">$set<span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">tting an attribute on </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="font-family: LMRoman9-Regular;">the DOM.</span></div>
<div><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">• How attribute changes can be observed, and how that only applies to attributes set </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="font-family: LMRoman9-Regular;">using</span> <span style="font-family: LMMono9-Regular;">$set</span> <span style="font-family: LMRoman9-Regular;">and not to attributes changed by other means.</span></div>
<div><span style="font-family: LMRoman9-Regular;">• That class directives also become attributes and may optionally have values attached </span><span style="font-family: LMRoman9-Regular;">to them.</span></div>
<div><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">• That comment directives also become attributes and may optionally have values </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="font-family: LMRoman9-Regular;">attached to them.</span></div>
<div><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;"><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">• How the <span style="font-family: LMMono9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">Attributes <span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">object provides some convenience methods for adding, removing, </span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span style="font-family: LMRoman9-Regular; color: rgb(0, 0, 0); font-style: normal; font-variant: normal;">and updating the CSS classes of the element.</span></div>
<div><br clear="none"/></div>
<div><br clear="none"/></div>
<div><br clear="none"/></div>
<div>Chapter 17：Directive Linking and Scopes</div>
<div>之前两章建立了DOM compilation，遍历整个DOM tree并找到能够应用到特定元素上的directives。这一章做的是Angular directive system的下一步，Linking。</div>
<div>Linking是将compiled DOM tree和scope objects结合，包括了scope object中的所有application data and functions，以及dirty checking system。</div>
<div><br/></div>
<div>Public link function：将directives应用到DOM tree有两步：1，编译DOM tree，2，Link compile DOM tree to Scopes。$compile返回一个用来初始化linking的函数，叫做public link function。</div>
<div>该函数做的事情包括：1，将一些debug information以jQuery/jqLite data的形式放到DOM上。2，主要工作是初始化actual linking of directives to the DOM，也就是directive link functions。</div>
<div><br/></div>
<div>Directive link functions：每个directive可以有自己的link function，和compile function类似，区别在于：1，调用的时间不同，2，link function除了能够访问DOM element and Attributes object之外，还可以访问到链接的Scope object，通常application data and functionality所在的地方。</div>
<div>定义Directive linking functions的方法有几种：</div>
<div>1，directive的compile function返回一个link function。比如：</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/ADC50B93-50E8-42D8-8DE6-5EE0E5A41265.png" height="820" width="1112"/></div>
<div>这个link function有三个参数，我们期望scope=给public link function的scope，element=directive应用的element，arguments=这个elements的参数。这种compile function返回link function的pattern应用到了整个compilation and linking process的各个level。</div>
<div>实现时需要考虑这么几步：对于一个nodes的集合，返回一个composite link function来link所有的nodes。每个node有自己的node link function。目前compile nodes和link nodes是一对一的关系，但是之后不是这样（因为nodes可能会有变动）。步骤如下图：</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/C5CD99D2-3260-441C-A4FB-514FF6AEC7F6.png" height="192" width="1050"/></div>
<div>compile and link functions的关系：</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/2F6FDEB5-E22F-486D-B880-00B7ECD21341.png" height="818" width="942"/></div>
<div>Linking Child Nodes：当编译了整个DOM tree之后，directives on lower levels应该先link，也就是说child elements should be linked before parent element。另外加入父节点没有directives applied to it，子节点仍然应该get linked。</div>
<div><br/></div>
<div>Pre- and Post- Linking：存在两种link functions，Prelink functions在子节点被linked之前调用，postlink则在之后。</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/D0B2612B-8ECE-4B60-9304-9C9D49F66DA8.png" height="796" width="1052"/></div>
<div>现在确定link functions invocation的顺序是：1. Parent prelink 2. Child prelink 3. Child postlink 4. Parent postlink</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/8537EB83-C0C2-4CB8-ADEB-4EC4A214C6A3.png" height="540" width="886"/></div>
<div><br/></div>
<div>Keeping The Node List Stable for Linking：之前说过，composite link function目前需要compile nodes和link nodes一一对应，然而因为directives通常会进行操作DOM的活动，所以这并不一定成立。实现方式是在运行node link functions之前先copy一份node collection叫做stableNodeList，注意copy的时候要保留index：</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/DCC8B2C9-0CAB-4AD9-9A39-F7CB34DFFB92.png" height="216" width="798"/></div>
<div><br/></div>
<div>Linking directives across multiple nodes：multiElement directives的linking需要考虑从-start到-end element的所有elements的集合。在public link function和directive link function之间加了一层wrapper，用来根据start element和start, end attribute names来得到对应的element group。</div>
<div><br/></div>
<div>Linking and scope inheritance：在处理了linking process之后，目前所有的directive link functions 用的是同一个scope，现在需要让directive能够有自己的scope。当一个element至少有一个directive索取inherited scope的时候，这个元素上的所有directives都会使用这个inherited scope。当一个元素涉及了scope inheritance的时候，元素上会增加一个ng-scope的CSS class，和一个新的Scope object作为jQuery/jqLite data。</div>
<div>Directives may ask new scopes to be created, in which case the elements where the directives are applied - as well as all of their children - get the inherited scope.</div>
<div>实现：当看到一个directive在要求一个新的scope的时候，在composite link function使用scope = scope.$new()替换scope为子scope，并设置相应的attrs.$element。</div>
<div><br clear="none"/></div>
<div>Isolated Scopes：isolated scopes的特点是在scope hierarchy中但是不继承父scope的属性。当在directive中使用isolate scope的时候更容易让directive变得更加modular。Directive system允许使用isolate scope bindings将元素从surrounding environment绑定到isolate scope上，和前面的normal scope inheritance的区别在于这里的属性传递必须是显式的。如果一个directive使用了isolate scope不影响这个元素上的其他scope，也不影响子元素。</div>
<div>isolate scope不和该元素和其子元素的其他directives共享，并且一个元素只能有一个isolate scope，否则会throw。</div>
<div><br/></div>
<div>isolate attribute bindings：方法包括：1，让scope attributes 和element的属性绑定，element 的 attribute observer使用observe机制来更新scope attribute。优势在于因为所有directives共享同一个Attributes object，方便共享信息。</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/B47456CB-9CF1-40A6-AC41-4D2848DEA443.png" height="808" width="1112"/></div>
<div>scope中的anattr属性设置了character @，表示“Attribute bindings”。实现是在nodeLinkFn中，对于每个$$isolateBindings属性，设置attrs.$observe。attribute name和isolate scope中的name也可以修改，通过在directive的scope definition中设置别名在@后面，用正则表达式匹配。</div>
<div>2，bi-directional data binding：</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/FF32907C-9122-4146-9529-94644D2042E6.png" height="486" width="1058"/></div>
<div>最简单的双向绑定配置是在scope definition object里使用“=”符号，理解为“将这个属性看作是parent scope中的一个表达式”。双向绑定有用的时候在于你可以从parent scope的一些表达式中使用一些isolate scope中的属性。</div>
<div>实现步骤是：1，得到DOM中关于这个binding的expression string，用正则表达式，2，将这个字符串解析为Angular expression，使用$parse，3，在parent scope的上下文中执行编译得到的expression，4，将结果设为isolate scope的一个$watch的属性。</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/6152EC64-31ED-4C53-BD99-771D7B4FDA56.png" height="384" width="688"/></div>
<div>双向：当在isolate scope上assign an attribute时，可能影响到parent scope。双向的binding中parent优先。定义parentValueWatch函数监控parentValue，如果parentValue和lastValue不同说明parent有变化，赋值给child，否则child赋值给parent，并且更新lastValue。</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/DA9E838F-FA8B-46C2-8455-50D34A0389D6.png" height="346" width="836"/></div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/3996F822-4573-4268-BF69-98EDACD2C571.png" height="292" width="658"/></div>
<div>这里采用的是 reference watches，这对于数组等collection是无效的，因此需要使用$watchCollection，对应的特殊符号是”=*"。双向绑定可以设置为可选，意思是如果引用的attribute在DOM element上不存在，则不会创建对应的watcher，符号是“=?”。</div>
<div><br/></div>
<div>Expression binding：符号是”&amp;”，和之前两种绑定的区别在于这里主要用来绑定行为而不是数据，当你应用这个directive的时候，你给这个directive提供一个在某事件发生的时候可以调用的表达式，如ngClick这种event-driven directives的场景下最有用。</div>
<div><img src="%E3%80%8ABuild%20your%20own%20angularJS%E3%80%8BPart%205%EF%BC%881%EF%BC%89%3A%20%C2%A0Directives.resources/E0F00F8D-8B08-4162-A061-63CE364DF68F.png" height="330" width="714"/></div>
<div>Summary</div>
<div>By this point we have both of the core processes of the directive system implemented: Compilation and linking. We understand how directives and scopes interact and how the directive system creates new scopes.</div>
<div>In this chapter you have learned:</div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-family: Helvetica;">• How linking is built into the functions returned by the compile functions.</span></span></div>
<div><span style="font-family: Helvetica;">• How the public link function, the composite link functions, the node link functions, and the directive link functions are all return values of their respective compile </span><span style="font-family: Helvetica;">functions, and how they are chained together during linking.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-family: Helvetica;">• That a directive’s compile function should return its link function.<br/>
• That you can omit a directive’s compile function and supply the link function directly.<br/>
• How child nodes get linked whether the parent nodes have directives or not.</span></span></div>
<div><font face="Helvetica">• That prelink functions are invoked before child node linking, and post link functions </font><span style="font-family: Helvetica;">after it.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-family: Helvetica;">• That a link function is always a postlink function unless explicitly defined otherwise.</span></span></div>
<div><span style="font-family: Helvetica;">• How the linking process protects itself from DOM mutations that occur during </span><span style="font-family: Helvetica;">linking.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-family: Helvetica;">• How the nodes for multi-element directives are resolved during linking.<br/>
• How directives can request new, inherited scopes.</span></span></div>
<div><span style="font-family: Helvetica;">• That inherited scopes are shared by all the directives in the same element and its </span><span style="font-family: Helvetica;">children.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-family: Helvetica;">• How CSS classes and jQuery data are added to elements that have directives with </span></span><span style="font-family: Helvetica;">inherited scopes.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-family: Helvetica;">• How directives can request new isolate scopes.</span></span></div>
<div><span style="font-family: Helvetica;">• That isolate scopes are not shared between directives in the same element or its </span><span style="font-family: Helvetica;">children.</span></div>
<div><span style="font-family: Helvetica;">• That there can only be one isolate scope directive per element.</span></div>
<div><span style="font-family: Helvetica;">• That there cannot be inherited scope directives on an element when there is an isolate scope directive.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-family: Helvetica;">• How element attributes can be bound as observed values on an isolate scope.<br/>
• How bi-directional data bindings can be attached on an isolate scope.</span></span></div>
<div><span style="font-family: Helvetica;">• That when both the parent and child change simultaneously in a bi-directional data </span><span style="font-family: Helvetica;">binding, the parent takes precedence.</span></div>
<div><span style="font-style: normal; font-variant: normal; font-weight: normal;"><span style="font-family: Helvetica;">• How collections are supported in bi-directional data bindings.<br/>
• How invokable expressions can be attached on an isolate scope.</span></span></div>
<div><span style="font-family: Helvetica;">• How named arguments can be used with invokable expressions.</span></div>
<div><br clear="none"/></div>
<div><br clear="none"/></div>
<div><br clear="none"/></div>
<div><br clear="none"/></div>
<div><br clear="none"/></div>
<div><br clear="none"/></div>
<div><br clear="none"/></div>
<div><br clear="none"/></div>
<div><br clear="none"/></div>
<div><br clear="none"/></div>
</body></html>